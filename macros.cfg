# [include extruder-pa.cfg]
[include build-sheets.cfg]
[include filaments.cfg]
[include KAMP_Settings.cfg]
# [include auto-speed.cfg]
# [include klicky-probe.cfg]


[gcode_macro T0]
gcode:


## -------------------------------------------------------
## PRINT START & END
## -------------------------------------------------------

[gcode_macro PRINT_START]
gcode:
    START_PRINT {rawparams}

# [gcode_macro START_PRINT] # KLICKY
# description: Start print sequence with PA calculation, QGL, and mesh.
# gcode:
#     # --- Get Parameters from Slicer ---
#     {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
#     {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
#     {% set MATERIAL = params.MATERIAL|default("PLA")|upper %}
#     {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
#     {% set LAYER_HEIGHT = params.LAYER_HEIGHT|default(0.2)|float %}
#     {% set LINE_WIDTH = params.LINE_WIDTH|default(NOZZLE_SIZE * 1.25)|float %}
#     {% set PRINT_SPEED = params.PRINT_SPEED|default(60)|float %}
#     {% set TUBE_LENGTH = params.TUBE_LENGTH|default(0.5)|float %}

#     # --- NOZZLE SIZE VERIFICATION ---
#     {% set KLIPPER_NOZZLE = printer.extruder.nozzle_diameter %}
#     {% if (NOZZLE_SIZE - KLIPPER_NOZZLE)|abs > 0.01 %}
#         {action_raise_error("Nozzle size mismatch! Slicer: %.2fmm, Printer: %.2fmm. Run NOZZLE_%.0f to correct." % (NOZZLE_SIZE, KLIPPER_NOZZLE, NOZZLE_SIZE*100))}
#     {% endif %}

#     # --- Set initial printer state & filament profiles ---
#     SET_GCODE_OFFSET Z=0.0 MOVE=1
#     _SET_MPC_MATERIAL MATERIAL={MATERIAL}
#     _SET_FIRMWARE_RETRACTION MATERIAL={MATERIAL}

#     # --- Pressure Advance Calculation ---
#     _CALCULATE_PA MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} LAYER_HEIGHT={LAYER_HEIGHT} LINE_WIDTH={LINE_WIDTH} PRINT_SPEED={PRINT_SPEED} TUBE_LENGTH={TUBE_LENGTH}

#     # --- Printer Homing and Calibration Sequence ---
#     CONDITIONAL_HOME
#     SET_DOCKABLE_PROBE AUTO_ATTACH_DETACH=0
#     ATTACH_PROBE
#     SMART_PARK                     ; Move near bed (KAMP) to heat soak beacon
#     M140 S{BED_TEMP}               ; Start heating bed
#     M109 S{EXTRUDER_TEMP}          ; Set extruder temp and wait
#     G4 P60000                      ; Optional heat soak dwell for 60 seconds
#     M190 S{BED_TEMP}               ; Wait for bed to reach temp

#     BED_MESH_CLEAR
#     {% if not printer.save_variables.variables.qgl_leveled|default(False) %}
#         {action_respond_info("Gantry not leveled. Running QUAD_GANTRY_LEVEL.")}
#         QUAD_GANTRY_LEVEL
#     {% else %}
#         {action_respond_info("Gantry already leveled. Skipping QUAD_GANTRY_LEVEL.")}
#     {% endif %}

#     G28 Z
#     BED_MESH_CALIBRATE ADAPTIVE=1
#     DETACH_PROBE
#     SET_DOCKABLE_PROBE AUTO_ATTACH_DETACH=1
#     VORON_PURGE                    ; KAMP adaptive purge line
#     # --- Begin Print! ---


[gcode_macro START_PRINT] # BEACON
description: Advanced print start sequence for Beacon with dynamic PA.
gcode:
    # --- Get Parameters from Slicer ---
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    {% set MATERIAL = params.MATERIAL|default("PLA")|upper %}
    {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
    {% set LAYER_HEIGHT = params.LAYER_HEIGHT|default(0.2)|float %}
    {% set LINE_WIDTH = params.LINE_WIDTH|default(NOZZLE_SIZE * 1.25)|float %}
    {% set PRINT_SPEED = params.PRINT_SPEED|default(60)|float %}
    {% set TUBE_LENGTH = params.TUBE_LENGTH|default(0.5)|float %}

    # --- NOZZLE SIZE VERIFICATION ---
    {% set KLIPPER_NOZZLE = printer.extruder.nozzle_diameter %}
    {% if (NOZZLE_SIZE - KLIPPER_NOZZLE)|abs > 0.01 %}
        {action_raise_error("Nozzle size mismatch! Slicer: %.2fmm, Printer: %.2fmm. Run NOZZLE_%.0f to correct." % (NOZZLE_SIZE, KLIPPER_NOZZLE, NOZZLE_SIZE*100))}
    {% endif %}

    # --- Set initial printer state & filament profiles ---
    SET_GCODE_OFFSET Z=0.0 MOVE=1
    _SET_MPC_MATERIAL MATERIAL={MATERIAL}
    _SET_FIRMWARE_RETRACTION MATERIAL={MATERIAL}

    # --- Pressure Advance Calculation ---
    _CALCULATE_PA MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} LAYER_HEIGHT={LAYER_HEIGHT} LINE_WIDTH={LINE_WIDTH} PRINT_SPEED={PRINT_SPEED} TUBE_LENGTH={TUBE_LENGTH}

    # --- Homing and Heating Sequence ---
    BED_MESH_CLEAR
    SET_GCODE_OFFSET Z=0
    
    G28                          ; Home all axes
    SMART_PARK                   ; Move near bed to heat soak beacon
    M140 S{BED_TEMP}             ; Start heating bed

    {% if sheet and sheet.name | lower == 'smooth pei' %}
        {action_respond_info("Smooth PEI sheet detected. Heating nozzle to 150Â°C for probing.")}
        M109 S150
        {% set OFFSET = 0.06 %}
    {% else %}
        {action_respond_info("Textured or other sheet detected. Heating nozzle to full temp for probing.")}
        M109 S{EXTRUDER_TEMP}
        {% set OFFSET = 0.03 %}
    {% endif %}

    M190 S{BED_TEMP}             ; Wait for bed to reach temperature

    # # Nozzle Wipe Macro to ensure first layer Beacon contact is accurate
    # WIPE_NOZZLE

    # --- Calibration Sequence ---
    G28 Z METHOD=CONTACT CALIBRATE=1     ; Calibrate Z offset and Beacon model
    QUAD_GANTRY_LEVEL                    ; Level gantry
    BED_MESH_CALIBRATE RUNS=2            ; Create bed mesh (no need for adaptive, takes 20 seconds)

    # Optional: Re-check Z offset after QGL
    G28 Z METHOD=CONTACT CALIBRATE=0     ; post QGL Z-calibration

    # --- Final Heating and Purge ---
    M104 S{EXTRUDER_TEMP}
    M109 S{EXTRUDER_TEMP}        ; Ensure nozzle is at final print temp

    # Optional: Apply a Z offset for thermal expansion
    SET_GCODE_OFFSET Z={OFFSET}

    VORON_PURGE                  ; Adaptive purge (KAMP)
    # --- Begin Print! ---


[gcode_macro PRINT_END]
gcode:
    END_PRINT {rawparams}

    
[gcode_macro END_PRINT]
gcode:
    # Move nozzle away from print while retracting
    G91
    G1 Z5 E-2 F800
    G1 X-2 Y-2 E2 F800 ;Extrude slightly 
    G1 X-2 Y-2 E-18 F800
    G1 X-20 Y-20 F800
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Park nozzle
    PARK
    G90
    # # Disable steppers
    # M84


[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Park nozzle
    PARK
    G90
    # # Disable steppers
    # M84
    BASE_CANCEL_PRINT

## -------------------------------------------------------
## MOVEMENT MACROS
## -------------------------------------------------------

[gcode_macro FRONT]
description: Move toolhead to the front-center of the bed
gcode:
    {% set x_center = printer.toolhead.axis_maximum.x / 2 %}
    {% set y_front = printer.toolhead.axis_minimum.y + 10 %}
    G90
    G0 X{x_center} Y{y_front} F{6000}

[gcode_macro CENTER]
description: Move toolhead to the absolute center of the bed
gcode:
    {% set x_center = printer.toolhead.axis_maximum.x / 2 %}
    {% set y_center = printer.toolhead.axis_maximum.y / 2 %}
    G90
    G0 X{x_center} Y{y_center} F{6000}

[gcode_macro REAR]
description: Move toolhead to the rear-center of the bed
gcode:
    {% set x_center = printer.toolhead.axis_maximum.x / 2 %}
    {% set y_rear = printer.toolhead.axis_maximum.y - 10 %}
    G90
    G0 X{x_center} Y{y_rear} F{6000}

[gcode_macro PARK]
description: Park the toolhead at a specified or default location.
gcode:
    # --- Get live printer dimensions and speeds ---
    {% set z_max = printer.toolhead.axis_maximum.z %}
    {% set z_pos = printer.toolhead.position.z %}
    {% set y_max = printer.toolhead.axis_maximum.y %}
    {% set x_max = printer.toolhead.axis_maximum.x %}
    {% set travel_speed = printer.toolhead.max_velocity * 0.7 * 60 %}
    {% set z_travel_speed = printer.configfile.settings.printer.max_z_velocity * 20 %}
    
    # --- Define default park height ---
    {% set park_height = (z_max * 0.65)|int %}

    # --- Set park coordinates from parameters or defaults ---
    # The default park position is the back-right corner.
    {% set x_park = params.X|default(x_max - 5) %}
    {% set y_park = params.Y|default(y_max - 5) %}
    {% set z_park = params.Z|default(park_height)|float %}
    
    # --- Save current G-Code state ---
    SAVE_GCODE_STATE NAME=PARK_STATE
    
    # --- Move Z axis to a safe height ---
    G90 ; Use absolute coordinates
    {% if z_pos < z_park %}
        G1 Z{z_park} F{z_travel_speed} ; Move up to park height
    {% endif %}
    
    # --- Move X and Y axes to park position ---
    G1 X{x_park} Y{y_park} F{travel_speed}
    
    # --- Restore G-Code state ---
    RESTORE_GCODE_STATE NAME=PARK_STATE
    
[gcode_macro PRESENT]
description: Presents the print on a CoreXY by moving the toolhead to the front-center.
gcode:
    # --- Get printer axis limits ---
    {% set x_max = printer.toolhead.axis_maximum.x %}
    {% set y_min = printer.toolhead.axis_minimum.y %}
    {% set z_max = printer.toolhead.axis_maximum.z %}
    
    # --- Calculate center of X-axis ---
    {% set x_center = x_max / 2 %}
    
    # --- Call the PARK macro to move the toolhead ---
    # Moves to the front of the Y-axis and the center of the X-axis.
    PARK X={x_center} Y={y_min + 5} Z={z_max - 30}


## -------------------------------------------------------
## CONDITIONAL MACROS
## -------------------------------------------------------

[gcode_macro CONDITIONAL_HOME]
description: Homes the printer if it has not been homed yet.
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}


## -------------------------------------------------------
## UPDATE MACROS
## -------------------------------------------------------

[gcode_macro _SET_MPC_MATERIAL]
description: Set heater MPC parameters for a given material
variable_filament_table:
    ## Update this table to adjust material settings
    {
        ## ( density, heat capacity )  # suggested heat capacity range
        "PLA"       : ( 1.25, 2.20 ),  # 1.80 - 2.20
        "PETG"      : ( 1.27, 2.20 ),  # 1.70 - 2.20
        "ABS"       : ( 1.08, 2.40 ),  # 1.25 - 2.40
        "ASA"       : ( 1.09, 1.50 ),  # 1.30 - 2.10
    }
gcode:
    {% set material = params.MATERIAL | upper %}
    {% set heater = params.HEATER | default('extruder') %}
    {% set extruder_config = printer.configfile.settings[heater] %}

    {% if material in filament_table %}
        {% set (density, heat_capacity) = filament_table[material] %}

        RESPOND PREFIX=ð¥ MSG="Configured {heater} MPC for {material}. Density: {density}, Heat Capacity: {heat_capacity}"
    {% else %}
        {% set density = extruder_config.filament_density %}
        {% set heat_capacity=extruder_config.filament_heat_capacity %}

        RESPOND PREFIX=ð¥ MSG="Unknown material '{material}', using default mpc parameters for {heater}"
    {% endif %}

    MPC_SET HEATER={heater} FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={heat_capacity}

[gcode_macro _SET_FIRMWARE_RETRACTION]
description: Set printer retract parameters for given materials
variable_filament_table:
# The format for each entry is:
# "MATERIAL_NAME": (retract_length, retract_speed, unretract_extra_length, unretract_speed)
  {
    # --- Common Filaments ---
    "PLA":    (0.5, 30, 0.2, 20),
    "PETG":   (1.0, 30, 0.8, 20),
    "ASA":    (0.3, 30, 0.2, 20),
    "ABS":    (0.2, 30, 0.1, 20),    
  }

gcode:
  {% set material = params.MATERIAL | default('PLA') | upper %}

  # Check if the provided material exists in our table.
  {% if material in filament_table %}
    # Retrieve the settings from the table.
    {% set R_LENGTH, R_SPEED, U_EXTRA, U_SPEED = filament_table[material] %}

    # Send a message to the console confirming the change.
    RESPOND PREFIX=â¬ï¸ TYPE=command MSG="Setting firmware retraction for {material}. Retract Length: {R_LENGTH} Retract Speed: {R_SPEED} Load Length: {U_EXTRA} Load Speed: {U_SPEED}"

    # Apply the new retraction settings.
    SET_RETRACTION RETRACT_LENGTH={R_LENGTH} RETRACT_SPEED={R_SPEED} UNRETRACT_EXTRA_LENGTH={U_EXTRA} UNRETRACT_SPEED={U_SPEED}

  {% else %}
    # If the material is not found, raise an error.
    { action_raise_error("Unknown material: '" ~ material ~ "'. Please add it to the _SET_FIRMWARE_RETRACTION macro table.") }
  {% endif %}

[gcode_macro _CALCULATE_PA]
description: Automatically calculate and save Pressure Advance by material and nozzle size.
gcode:
    {% set material = params.MATERIAL | default("PLA") | upper %}
    {% set nozzle_size = params.NOZZLE_SIZE | default(0.4) | float %}
    {% set layer_height = params.LAYER_HEIGHT | default(0.2) | float %}
    {% set line_width = params.LINE_WIDTH | default(nozzle_size * 1.25) | float %}
    {% set print_speed = params.PRINT_SPEED | default(60) | float %}
    {% set tube_length_cm = params.TUBE_LENGTH | default(0.5) | float %}
    {% set filament_diameter = params.FILAMENT_DIAMETER | default(1.75) | float %}

    {% set material_constants = {
        'PLA': 85, 'PETG': 100, 'ABS': 95, 'ASA': 100,
        'TPU': 140, 'FLEX': 140, 'NYLON': 120, 'PA': 120, 'PVB': 85
    } %}

    {% if material in material_constants %}
        {% set K = material_constants[material] %}
        {% set tube_length_dm = tube_length_cm / 10.0 %}
        {% set filament_area = (3.14159 * (filament_diameter / 2) ** 2) %}
        {% set flow_rate = line_width * layer_height * print_speed %}
        {% set pressure_advance = (flow_rate * tube_length_dm) / (K * filament_area) %}
        
        # Save PA with key specific to material and nozzle size
        SAVE_VARIABLE VARIABLE="pa_{ material }_{ nozzle_size|round(2) }" VALUE="{ pressure_advance|round(4) }"

        SET_PRESSURE_ADVANCE ADVANCE={pressure_advance}

        RESPOND TYPE=command MSG="â¬ï¸ Calculated PA for { material } @ { nozzle_size|round(2) }mm: { pressure_advance|round(4) } (saved)"
    {% else %}
        RESPOND TYPE=command MSG="â ï¸ Unknown material '{ material }' for PA calculation. Using printer default."
    {% endif %}

[gcode_macro SHOW_SAVED_PA]
description: Show all saved Pressure Advance values for materials and nozzle sizes.
gcode:
    {% set svv = printer.save_variables.variables %}
    RESPOND TYPE=command MSG="ð¦ Saved Pressure Advance values:"
    {% for key, value in svv.items() %}
        {% if key.startswith('pa_') %}
            {% set parts = key.split('_') %}
            {% set mat = parts[1] %}
            {% set noz = parts[2] %}
            RESPOND TYPE=command MSG="â¢ { mat } @ { noz }mm â PA = { value }"
        {% endif %}
    {% endfor %}


[gcode_macro TEST_PA_PATTERN]
description: Print Ellis-style corner test and interactively save Pressure Advance
variable_best_pa: 0.0
gcode:
    {% set start_pa = params.START | default(0.0) | float %}
    {% set step_pa = params.STEP | default(0.01) | float %}
    {% set loops = params.LOOPS | default(5) | int %}
    {% set square_size = params.SIZE | default(40) | float %}
    {% set offset = params.OFFSET | default(5) | float %}
    {% set speed = params.SPEED | default(60) | float %}
    {% set layer_height = params.LAYER_HEIGHT | default(0.2) | float %}
    {% set height = params.HEIGHT | default(layer_height) | float %}
    {% set filament_diameter = params.FILAMENT_DIAMETER | default(1.75) | float %}
    {% set line_width = params.LINE_WIDTH | default(0.45) | float %}
    {% set material = params.MATERIAL | default("PLA") | upper %}

    G28
    G90
    G1 Z5 F600
    G92 E0

    TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START={start_pa} END={ start_pa + step_pa * (loops - 1) }

    {% set filament_area = 3.14159 * (filament_diameter / 2) ** 2 %}
    {% set flow_per_mm = line_width * layer_height / filament_area %}

    G1 X50 Y50 Z{layer_height} F6000
    G92 E0

    {% for i in range(loops) %}
        {% set current_pa = start_pa + step_pa * i %}
        {% set x0 = 50 + offset * i %}
        {% set y0 = 50 %}
        {% set x1 = x0 + square_size %}
        {% set y1 = y0 + square_size %}
        G1 X{x0} Y{y0} F6000
        G1 X{x1} Y{y0} E{ (x1 - x0) * flow_per_mm } F{ speed * 60 }
        G1 X{x1} Y{y1} E{ (y1 - y0) * flow_per_mm }
        G1 X{x0} Y{y1} E{ (x1 - x0) * flow_per_mm }
        G1 X{x0} Y{y0} E{ (y1 - y0) * flow_per_mm }
    {% endfor %}

    TUNING_TOWER RESET
    G1 Z10 F1000
    G1 X0 Y0 F6000
    M400

    RESPOND PREFIX=ð§ª TYPE=command MSG="PA Pattern complete. Visually inspect corners."
    RESPOND PREFIX=ð§­ TYPE=command MSG="Enter best PA value via: TEST_PA_PATTERN_STORE BEST=0.045 (replace with your result)"

[gcode_macro TEST_PA_PATTERN_STORE]
description: Stores chosen PA value from TEST_PA_PATTERN
gcode:
    {% set best = params.BEST | float %}
    {% set material = params.MATERIAL | default("PLA") | upper %}
    {% set nozzle_size = params.NOZZLE_SIZE | default(0.4) | float %}

    SET_PRESSURE_ADVANCE ADVANCE={best}
    SAVE_VARIABLE VARIABLE="pa_{ material }_{ nozzle_size|round(2) }" VALUE="{ pressure_advance|round(4) }"

    RESPOND PREFIX=ð¾ TYPE=command MSG="Saved and applied PA for { material }: { best }"
    REACTOR_LOG MSG="User saved PA for { material } = { best }"


## -------------------------------------------------------
## Nozzle && Filaments
## -------------------------------------------------------

[gcode_macro NOZZLE_40]
gcode:
    CHANGE_NOZZLE NOZZLE_DIAMETER=0.4

[gcode_macro NOZZLE_60]
gcode:
    CHANGE_NOZZLE NOZZLE_DIAMETER=0.6

## Filaments stored in Filaments.cfg

## -------------------------------------------------------
## LEDs
## -------------------------------------------------------

[gcode_macro _klicky_status_ready]
gcode:
    {% if printer['gcode_macro status_ready'] is defined %}
        _KlickyDebug msg="_klicky_status_ready activating the LED STATUS_READY"
        STATUS_READY
    {% endif %}

[gcode_macro _klicky_status_busy]
gcode:
    {% if printer['gcode_macro status_busy'] is defined %}
        _KlickyDebug msg="_klicky_status_busy activating the LED STATUS_BUSY"
        STATUS_BUSY
    {% endif %}

[gcode_macro _klicky_status_leveling]
gcode:
    {% if printer['gcode_macro status_leveling'] is defined %}
        _KlickyDebug msg="_klicky_status_leveling activating the LED STATUS_LEVELING"
        STATUS_LEVELING
    {% endif %}

[gcode_macro _klicky_status_homing]
gcode:
    {% if printer['gcode_macro status_homing'] is defined %}
        _KlickyDebug msg="_klicky_status_homing activating the LED STATUS_HOMING"
        STATUS_HOMING
    {% endif %}

[gcode_macro _klicky_status_cleaning]
gcode:
    {% if printer['gcode_macro status_cleaning'] is defined %}
        _KlickyDebug msg="_klicky_status_cleaning activating the LED STATUS_CLEANING"
        STATUS_CLEANING
    {% endif %}

[gcode_macro _klicky_status_meshing]
gcode:
    {% if printer['gcode_macro status_meshing'] is defined %}
        _KlickyDebug msg="_klicky_status_meshing activating the LED STATUS_MESHING"
        STATUS_MESHING
    {% endif %}

[gcode_macro _klicky_status_calibrating_z]
gcode:
    {% if printer['gcode_macro status_calibrating_z'] is defined %}
        _KlickyDebug msg="_klicky_status_calibrating_z activating the LED STATUS_CALIBRATING_Z"
        STATUS_CALIBRATING_Z
    {% endif %}


## -------------------------------------------------------
## OVERRIDES
## -------------------------------------------------------


[gcode_macro M109] # Wait Hotend Temp
rename_existing: M109.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  # Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+5}   # Wait for hotend temp (within n degrees)
    {% endif %}


[gcode_macro M190] # Wait Bed Temp
rename_existing: M190.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   # Set bed temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-1} MAXIMUM={s+5}  # Wait for bed temp (within n degrees)
    {% endif %}


[delayed_gcode _klipper_shutdown_stage_2]
# This delayed G-code macro performs the host machine shutdown actions.
# It is triggered 35 seconds after _klipper_shutdown_stage_1 issues BACKUP_CFG.
initial_duration: 0 # This ensures it only runs when explicitly updated.
gcode:
    {action_respond_info('action:poweroff')}    ; OctoPrint compatible host shutdown
    {action_call_remote_method("shutdown_machine")} ; Moonraker compatible host shutdown

#-----------------------------------------------------------------------------

[delayed_gcode _klipper_shutdown_stage_1]
# This delayed G-code macro handles the configuration backup.
# It is triggered 1 second after the OFF macro completes.
initial_duration: 0 # This ensures it only runs when explicitly updated.
gcode:
    # Perform the configuration backup
    BACKUP_CFG
    # Schedule the final power-off stage.
    # This accounts for the 35-second delay from the original SHUTDOWN macro.
    # The duration is set to 35 seconds, meaning the power-off will occur 35 seconds
    # after the BACKUP_CFG command has been issued.
    UPDATE_DELAYED_GCODE ID=_klipper_shutdown_stage_2 DURATION=35

#-----------------------------------------------------------------------------

[gcode_shell_command backup_cfg]
command: ~/printer_data/config/autocommit.sh
timeout: 30
verbose: True

#-----------------------------------------------------------------------------

[gcode_macro BACKUP_CFG]
description: Backs up config directory GitHub
gcode:
    RUN_SHELL_COMMAND CMD=backup_cfg


#-----------------------------------------------------------------------------
    
[gcode_macro OFF]
gcode:
    M84                                         ; Turn steppers off
    TURN_OFF_HEATERS                            ; Turn bed / hotend off
    M107                                        ; Turn print cooling fan off
    # SET_FAN_SPEED FAN=MCU_fan SPEED=0           ; turn controller fan off
    SET_FAN_SPEED FAN=chamber_filter SPEED=0    ; turn chamber filter fan off
    SET_PIN PIN=caselight VALUE=0.00            ; turn case light off
    # Schedule the next stage of shutdown (backup) after a short delay (1 second)
    # This replaces the initial G4 P1000 from the original SHUTDOWN macro.
    UPDATE_DELAYED_GCODE ID=_klipper_shutdown_stage_1 DURATION=1
