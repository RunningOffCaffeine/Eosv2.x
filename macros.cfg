# [include extruder-pa.cfg]
[include build-sheets.cfg]
[include filaments.cfg]
[include auto-speed.cfg]
[include TEST_SPEED/test_speed.cfg]
[include CALIBRATION/tuning_macros.cfg]
[include KAMP_Override.cfg]
# [include led_config_BARF.cfg]


## -------------------------------------------------------
## LEDs
## -------------------------------------------------------


[gcode_macro _STATUS_READY]
gcode:
  SET_LED LED="rgb_light" RED=0.843 GREEN=0.145 BLUE=0.576 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=0.843 GREEN=0.145 BLUE=0.576 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=0.843 GREEN=0.145 BLUE=0.576 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=3

[gcode_macro _SET_STATUS_READY]
gcode:
    {% if printer['gcode_macro _STATUS_READY'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to READY"
        _STATUS_READY
    {% endif %}

[delayed_gcode _set_led_to_ready]
initial_duration: 1 # This ensures it runs 1 second after printer bootup
gcode:
    _SET_STATUS_READY


[gcode_macro _STATUS_BUSY]
gcode:
  SET_LED LED="rgb_light" RED=1 GREEN=0.5 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=1 GREEN=0.5 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=1 GREEN=0.5 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=3
  
[gcode_macro _SET_STATUS_BUSY]
gcode:
    {% if printer['gcode_macro _STATUS_BUSY'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to BUSY"
        _STATUS_BUSY
    {% endif %}


[gcode_macro _STATUS_HEATING]
gcode:
  SET_LED LED="rgb_light" RED=1 GREEN=0 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=1 GREEN=0 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=1 GREEN=0 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=3

[gcode_macro _SET_STATUS_HEATING]
gcode:
    {% if printer['gcode_macro _STATUS_HEATING'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to HEATING"
        _STATUS_HEATING
    {% endif %}


[gcode_macro _STATUS_LEVELING]
gcode:
  SET_LED LED="rgb_light" RED=0.337 GREEN=0.922 BLUE=0.067 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=0.337 GREEN=0.922 BLUE=0.067 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=0.337 GREEN=0.922 BLUE=0.067 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=3
  
[gcode_macro _SET_STATUS_LEVELING]
gcode:
    {% if printer['gcode_macro _STATUS_LEVELING'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to LEVELING"
        _STATUS_LEVELING
    {% endif %}


[gcode_macro _STATUS_HOMING]
gcode:
  SET_LED LED="rgb_light" RED=0.604 GREEN=0.922 BLUE=0.063 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=0.604 GREEN=0.922 BLUE=0.063 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=0.604 GREEN=0.922 BLUE=0.063  WHITE=0 SYNC=0 TRANSMIT=1 INDEX=3

[gcode_macro _SET_STATUS_HOMING]
gcode:
    {% if printer['gcode_macro _STATUS_HOMING'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to HOMING"
        _STATUS_HOMING
    {% endif %}


[gcode_macro _STATUS_CLEANING]
gcode:
  SET_LED LED="rgb_light" RED=0.063 GREEN=0.722 BLUE=0.922 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=1 GREEN=1 BLUE=0 WHITE=1 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=1 GREEN=1 BLUE=0  WHITE=1 SYNC=0 TRANSMIT=1 INDEX=3

[gcode_macro _SET_STATUS_CLEANING]
gcode:
    {% if printer['gcode_macro _STATUS_CLEANING'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to CLEANING"
        _STATUS_CLEANING
    {% endif %}


[gcode_macro _STATUS_MESHING]
gcode:
  SET_LED LED="rgb_light" RED=0.89 GREEN=0.612 BLUE=0.059 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=1 GREEN=1 BLUE=0 WHITE=1 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=0 GREEN=0 BLUE=1  WHITE=1 SYNC=0 TRANSMIT=1 INDEX=3

[gcode_macro _SET_STATUS_MESHING]
gcode:
    {% if printer['gcode_macro _STATUS_MESHING'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to MESHING"
        _STATUS_MESHING
    {% endif %}


[gcode_macro _STATUS_CALIBRATING_Z]
gcode:
  SET_LED LED="rgb_light" RED=0.094 GREEN=0.988 BLUE=0.145 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=1 GREEN=1 BLUE=1 WHITE=1 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=1 GREEN=1 BLUE=1  WHITE=1 SYNC=0 TRANSMIT=1 INDEX=3

[gcode_macro _SET_STATUS_CALIBRATING_Z]
gcode:
    {% if printer['gcode_macro _STATUS_CALIBRATING_Z'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to CALIBRATING_Z"
        _STATUS_CALIBRATING_Z
    {% endif %}


[gcode_macro _STATUS_PURGING]
gcode:
  SET_LED LED="rgb_light" RED=1 GREEN=0.498 BLUE=0.522 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=1 GREEN=1 BLUE=1 WHITE=1 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=1 GREEN=1 BLUE=1  WHITE=1 SYNC=0 TRANSMIT=1 INDEX=3
  
[gcode_macro _SET_STATUS_PURGING]
gcode:
    {% if printer['gcode_macro _STATUS_PURGING'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to PURGING"
        _STATUS_PURGING
    {% endif %}


[gcode_macro _STATUS_PRINTING]
gcode:
  SET_LED LED="rgb_light" RED=0.843 GREEN=0.145 BLUE=0.576 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=1 GREEN=1 BLUE=1 WHITE=1 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=1 GREEN=1 BLUE=1  WHITE=1 SYNC=0 TRANSMIT=1 INDEX=3
  
[gcode_macro _SET_STATUS_PRINTING]
gcode:
    {% if printer['gcode_macro _STATUS_PRINTING'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to PRINTING"
        _STATUS_PRINTING
    {% endif %}


[gcode_macro _STATUS_PAUSE]
gcode:
  SET_LED LED="rgb_light" RED=1 GREEN=0.647 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=1 GREEN=0.647 BLUE=0 WHITE=1 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=1 GREEN=0.647 BLUE=0  WHITE=1 SYNC=0 TRANSMIT=1 INDEX=3
  
[gcode_macro _SET_STATUS_PAUSE]
gcode:
    {% if printer['gcode_macro _STATUS_PRINTING'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to PAUSE"
        _STATUS_PAUSE
    {% endif %}


[gcode_macro _STATUS_RESUME]
gcode:
  SET_LED LED="rgb_light" RED=0 GREEN=1 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=0 GREEN=1 BLUE=0 WHITE=1 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=0 GREEN=1 BLUE=0  WHITE=1 SYNC=0 TRANSMIT=1 INDEX=3
  
[gcode_macro _SET_STATUS_RESUME]
gcode:
    {% if printer['gcode_macro _STATUS_PRINTING'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to RESUME"
        _STATUS_RESUME
    {% endif %}


[gcode_macro _STATUS_CANCEL]
gcode:
  SET_LED LED="rgb_light" RED=0.953 GREEN=0.125 BLUE=0.075 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=0.941 GREEN=0.835 BLUE=0 WHITE=1 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=0.792 GREEN=0.043 BLUE=0  WHITE=1 SYNC=0 TRANSMIT=1 INDEX=3
  
[gcode_macro _SET_STATUS_CANCEL]
gcode:
    {% if printer['gcode_macro _STATUS_PRINTING'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to CANCEL"
        _STATUS_CANCEL
    {% endif %}


[gcode_macro _STATUS_OFF]
gcode:
  SET_LED LED="rgb_light" RED=0 GREEN=0 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=1
  SET_LED LED="rgb_light" RED=0 GREEN=0 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=0 GREEN=0 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=3

[gcode_macro _HEADLIGHT_ON]
gcode:
  SET_LED LED="rgb_light" RED=1 GREEN=1 BLUE=1 WHITE=1 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=1 GREEN=1 BLUE=1  WHITE=1 SYNC=0 TRANSMIT=1 INDEX=3

[gcode_macro _HEADLIGHT_OFF]
gcode:
  SET_LED LED="rgb_light" RED=0 GREEN=0 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=2
  SET_LED LED="rgb_light" RED=0 GREEN=0 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1 INDEX=3

[gcode_macro _CASELIGHT_OFF]
gcode:
  SET_PIN PIN=caselight VALUE=0.00

[gcode_macro _CASELIGHT_ON]
gcode:
  ; 1. Calculate the initial power value (0.0 to 1.0)
  {% set raw_power = ((params.POWER|default(50)|int) / 100) | float %}
  
  ; 2. Clamp the raw value between a minimum of 0.0 and a maximum of 1.0
  ; First, clamp V to be no more than 1.0
  {% set final_power = [raw_power, 1.0]|min %}
  ; Then, clamp the result to be no less than 0.0
  {% set final_power = [final_power, 0.0]|max %}
  
  SET_PIN PIN=caselight VALUE={final_power}

[gcode_macro _SET_STATUS_OFF]
gcode:
    {% if printer['gcode_macro _STATUS_OFF'] is defined %}
        RESPOND PREFIX=‚ú®Ô∏è TYPE=command MSG="Setting printer status LED to OFF"
        _STATUS_OFF
        _HEADLIGHT_OFF
    {% endif %}


## Emits an audible tone, use in conjunction with a passive buzzer to create beeps of different pitch and durations
## Original code from: https://github.com/rootiest/zippy-klipper_config/blob/master/macros/M300.cfg
## Script that converts MIDI files to M300 gcode: https://alexyu132.github.io/midi-m300/
[gcode_macro M300]
gcode:
    {% set S = params.S|default(1000)|int %}  ; S sets the tone frequency (Hz)
    {% set P = params.P|default(100)|int %}   ; P sets the tone duration (ms)
    {% set V = params.V|default(0.5)|float %} ; V sets the volume (PWM duty cycle: 0.0 to 1.0)
    
    ; --- Volume/Duty Cycle Clamping ---
    ; First, clamp V to be no more than 1.0
    {% set L = [V, 0.95]|min %}
    ; Then, clamp the result to be no less than 0.0
    {% set L = [L, 0.0]|max %}
    
    ; --- Frequency Logic ---
    {% if S <= 0 %}            ; Don't divide through zero
        {% set F = 1 %}
        {% set L = 0 %}        ; Set duty cycle to 0 (silent) if S is 0
    {% elif S >= 10000 %}      ; Max frequency set to 10kHz
        {% set F = 0 %}
    {% else %}
        {% set F = 1/S %}      ; Convert frequency (Hz) to cycle time (seconds)
    {% endif %}
    
    SET_PIN PIN=_beeper VALUE={L} CYCLE_TIME={F} ; Play tone with specified volume (L)
    G4 P{P}                                    ; Tone duration (P)
    SET_PIN PIN=_beeper VALUE=0                ; Stop tone


[gcode_macro ERROR_BEEP]
gcode:
    # Retrieve the globally saved volume
    {% set beep_volume = params.V | default(0.5) | float %}

    M300 P12 S262 V{beep_volume}
    M300 P321 S196 V{beep_volume}
    M300 P538 S98 V{beep_volume}

# [gcode_macro COMPLETE_BEEP]
# gcode:
#     {% set VOL = params.V|default(0.5) %} ; Define a variable for clarity, using a default

## -------------------------------------------------------
## OVERRIDES
## -------------------------------------------------------


[gcode_macro M109] # Wait Hotend Temp
rename_existing: M109.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  # Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+5}   # Wait for hotend temp (within n degrees)
    {% endif %}


[gcode_macro M190] # Wait Bed Temp
rename_existing: M190.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   # Set bed temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-1} MAXIMUM={s+5}  # Wait for bed temp (within n degrees)
    {% endif %}


[gcode_macro M191] # Wait Chamber Temp
# rename_existing: M191.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M141 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   # Set chamber temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber" MINIMUM={s-1} MAXIMUM={s+5}  # Wait for chamber temp (within n degrees)
    {% endif %}

    
[gcode_macro G32]
gcode:
    CG28
    QUAD_GANTRY_LEVEL {rawparams}


[gcode_macro G29]
gcode:
    CG28
    MESH_CALIBRATE {rawparams}

    
[gcode_macro G28]
rename_existing: G28.1
gcode:
    {% set RPARAMS = rawparams|upper %}
    {% set home_x = 'X' in RPARAMS %}
    {% set home_y = 'Y' in RPARAMS %}
    {% set home_z = 'Z' in RPARAMS %}

    # If no parameters are given (e.g., a simple G28), home all axes
    {% if not rawparams %}
        {% set home_x = True %}
        {% set home_y = True %}
        {% set home_z = True %}
    {% endif %}
    
    _SET_STATUS_HOMING

    G28.1 {RPARAMS}
    # # --- Y-Axis Homing Logic ---
    # # Home Y if it was requested, OR if X or Z was requested and Y isn't homed yet.
    # # This block runs first, ensuring Y is always homed before X.
    # {% if home_y or (home_x and 'y' not in printer.toolhead.homed_axes) or (home_z and 'y' not in printer.toolhead.homed_axes) %}
    #     G28.1 Y
    #     _CLIENT_LINEAR_MOVE Y=-25 F=3600
    # {% endif %}

    # # --- X-Axis Homing Logic ---
    # # Home X if it was requested, OR if Z was requested and X isn't homed yet.
    # {% if home_x or (home_z and 'x' not in printer.toolhead.homed_axes) %}
    #     G28.1 X
    #     _CLIENT_LINEAR_MOVE X=-25 F=3600
    # {% endif %}

    # # --- Z-Axis Homing Logic ---
    # # Home Z only if it was explicitly requested. Its dependencies (X and Y) are handled above.
    # {% if home_z %}
    #     G28.1 Z {rawparams}
    # {% endif %}

    _SET_STATUS_READY
  

[gcode_macro QUAD_GANTRY_LEVEL]
# Rename the existing command so we can call it BASE_QGL
rename_existing: BASE_QGL 
gcode:
    _SET_STATUS_HOMING
    CG28
    
    _SET_STATUS_LEVELING
    BASE_QGL {rawparams}
    
    _SET_STATUS_HOMING
    G28 Z           ; Re-home Z after QGL adjustments
    _SET_STATUS_READY


# [gcode_macro AWD_BED_MESH_CALIBRATE]
# gcode:
#     BED_MESH_CLEAR
    
#     # Define a temporary profile for the exclusion logic
#     # This prevents conflicts with KAMP or other dynamic meshing
#     BED_MESH_CALIBRATE PROFILE=EXCLUSION_PROFILE
    
#     # 1. Front-Left Corner Exclusion (0,0) to (50, 50)
#     PROBE_FINESSE MIN_X=0 MAX_X=50 MIN_Y=0 MAX_Y=50 SKIP=1
    
#     # 2. Front-Right Corner Exclusion (Mirrors Front-Left)
#     # This excludes the area from X=300 to X=350, and Y=0 to Y=50.
#     PROBE_FINESSE MIN_X=300 MAX_X=350 MIN_Y=0 MAX_Y=50 SKIP=1
    
#     # 3. Run the actual calibration with the exclusion points skipped
#     BED_MESH_CALIBRATE PROFILE=EXCLUSION_PROFILE

[gcode_macro MESH_CALIBRATE]
description: Macro to call BED_MESH_CALIBRATE with LED colors for MESHING.
gcode:
    _SET_STATUS_MESHING
    BED_MESH_CALIBRATE ADAPTIVE=1 {rawparams} # USE_CONTACT_AREA=1
    _SET_STATUS_READY


[gcode_macro T0]
gcode:


## -------------------------------------------------------
## PRINT START & END
## -------------------------------------------------------

[gcode_macro HEAT_SOAK]
description: Heats the bed (passively heating the chamber), then soaks. [TARGET], [CHAMBER], [DURATION]
variable_target_temp: 0
variable_chamber_target_temp: 0
variable_stage: None # heating_bed -> heating_chamber -> soaking -> done -> None

## in seconds
variable_check_interval: 10
variable_soak_time_remaining: 0
variable_total_time_elapsed: 0

gcode:
    {% set TARGET = params.TARGET | default(0) | float %}
    {% set CHAMBER_TARGET = params.CHAMBER | default(0) | float %}
    {% set DURATION = (params.DURATION | default(5) | int) * 60 %} ## minutes to seconds

    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=target_temp           VALUE={ TARGET }
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=chamber_target_temp   VALUE={ CHAMBER_TARGET }
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage                 VALUE="'heating_bed'"
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining   VALUE={ DURATION }
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed    VALUE=0

    CG28
    
    # Fire up the bed heater (this will also passively heat the chamber)
    _SET_STATUS_HEATING
    M140 S{ TARGET }

    # Run the fan to circulate air
    SET_FAN_SPEED FAN=chamber_filter SPEED=255

    # Park the toolhead
    CENTER
    # PARK_WIPE_PARK

    # M84 # turn off steppers

    UPDATE_DELAYED_GCODE ID=heat_soaker DURATION={ check_interval }

[gcode_macro CANCEL_HEAT_SOAK]
description: Cancels an in-progress HEAT_SOAK cycle.
gcode:
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage VALUE="'cancel'"
    UPDATE_DELAYED_GCODE ID=heat_soaker DURATION=1

[delayed_gcode heat_soaker]
gcode:
    {% set heat_soak = printer['gcode_macro HEAT_SOAK'] %}

    ## update total time elapsed
    {% set total_time_elapsed = heat_soak.total_time_elapsed + heat_soak.check_interval %}
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed VALUE={ total_time_elapsed }

    {% set stage = heat_soak.stage %}
    {% set target_bed = heat_soak.target_temp %}
    {% set target_chamber = heat_soak.chamber_target_temp %}

    # Get the chamber sensor object (must match your config)
    {% set chamber_sensor = printer["temperature_sensor Chamber"] %}

    # --- State Machine ---
    {% if stage == "heating_bed" %}
        # Wait for bed to reach temp
        {% if printer.heater_bed.temperature >= target_bed %}
            {% if target_chamber > 0 %}
                {% set stage = "heating_chamber" %} # Move to check chamber
            {% else %}
                {% set stage = "soaking" %}         # No chamber wait, start soaking
            {% endif %}
        {% endif %}

    {% elif stage == "heating_chamber" %}
        # Wait for *passive* chamber sensor to reach temp
        {% if chamber_sensor.temperature >= target_chamber %}
            {% set stage = "soaking" %} # Chamber is hot, start soaking
        {% endif %}

    {% elif stage == "soaking" %}
        # Countdown soak time
        {% set soak_time_remaining = [heat_soak.soak_time_remaining - heat_soak.check_interval, 0] | max %}
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining VALUE={ soak_time_remaining }

        {% if soak_time_remaining == 0 %}
            {% set stage = "done" %}
        {% endif %}
    {% endif %}

    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage VALUE="'{ stage }'"
    # --- End State Machine ---


    {% if stage in ("done", "cancel") %}
        # --- Cleanup ---
        {% if stage == "cancel" %}
            {% set stage = "done" %}
            TURN_OFF_HEATERS # This will turn off the bed heater
            SET_FAN_SPEED FAN=chamber_filter SPEED=0

            M117 { "soak cancelled after ~%.1fm" | format(total_time_elapsed / 60.0) }
            _SET_STATUS_READY
        {% else %}
            M117 { "soak complete after %.1fm" | format(total_time_elapsed / 60.0) }
            _SET_STATUS_READY
        {% endif %}

        ## reset all state vars
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=target_temp           VALUE=0
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=chamber_target_temp   VALUE=0
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining   VALUE=0
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed    VALUE=0

    {% else %}
        # --- Reschedule ---
        {% if total_time_elapsed % 30 == 0 %}
            ## output status periodically
            {% if stage == "heating_bed" %}
                M117 { "heating bed (%.0fC) -- %.1fm elapsed" | format(printer.heater_bed.temperature, total_time_elapsed / 60.0) }
            {% elif stage == "heating_chamber" %}
                M117 { "heating chamber (%.0fC) -- %.1fm elapsed" | format(chamber_sensor.temperature, total_time_elapsed / 60.0) }
            {% elif stage == "soaking" %}
                M117 { "soaking -- %.1fm remaining" | format(soak_time_remaining / 60.0) }
            {% endif %}
        {% endif %}

        ## trigger ourselves again
        UPDATE_DELAYED_GCODE ID=heat_soaker DURATION={ heat_soak.check_interval }

        ## dwell for 1ms to prevent from going idle
        G4 P1

    {% endif %}


[gcode_macro PHASE_1]
description: Sets profiles, heats bed/nozzle to targets, and homes Z. (Heat Soak assumed external/complete).
gcode:
    _SET_STATUS_READY

    # --- Get all slicer parameters ---
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    {% set MATERIAL = params.MATERIAL|default("PLA")|upper %}
    {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
    {% set LAYER_HEIGHT = params.LAYER_HEIGHT|default(0.2)|float %}
    {% set PRINT_SPEED = params.PRINT_SPEED|default(60)|float %}
    {% set TUBE_LENGTH = params.TUBE_LENGTH|default(0.5)|float %}

    # --- NOZZLE SIZE VERIFICATION ---
    {% set KLIPPER_NOZZLE = printer.extruder.nozzle_diameter %}
    {% if (NOZZLE_SIZE - KLIPPER_NOZZLE)|abs > 0.01 %}
        {action_raise_error("Nozzle size mismatch! Slicer: %.2fmm, Printer: %.2fmm." % (NOZZLE_SIZE, KLIPPER_NOZZLE))}
    {% endif %}

    # --- Set initial printer state & filament profiles ---
    M117 Setting material profiles...
    SET_GCODE_OFFSET Z=0 MOVE=1

    # Quick M104 switch so MPC gets set properly
    M104 S{EXTRUDER_TEMP}
    _SET_MPC_MATERIAL MATERIAL={MATERIAL}
    M104 S0
    
    _SET_FIRMWARE_RETRACTION MATERIAL={MATERIAL}

    # --- Pressure Advance Calculation ---
    _CALCULATE_PA MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} LAYER_HEIGHT={LAYER_HEIGHT} PRINT_SPEED={PRINT_SPEED} TUBE_LENGTH={TUBE_LENGTH}

    # --- Heating and Homing ---
    BED_MESH_CLEAR
    M117 Heating bed...

    _SET_STATUS_HEATING
    
    # 1. Start Bed Heating
    M140 S{BED_TEMP} 
    
    # 2. Preheat nozzle safely (150C) to prevent cold extrusion errors but allow fan usage
    M104 S150 

    # 3. Park at Drip Stop while waiting
    CG28              ; Conditional home (only if needed)
    PARK_WIPE_PARK    ; Wipe and move to X45 Y350
    
    # 4. Wait for Bed Temp
    M190 S{BED_TEMP}

    # --- Nozzle Heating for Probing ---
    M117 Heating nozzle to probe temp...
    {% if sheet and sheet.name | lower == 'textured_pei' %}
        {action_respond_info("Textured PEI detected. Heating nozzle to full temp (" ~ EXTRUDER_TEMP ~ "¬∞C) for probing.")}
        M109 S{EXTRUDER_TEMP}
    {% else %}
        {action_respond_info("Standard sheet detected. Heating nozzle to 150¬∞C for probing.")}
        M109 S150
    {% endif %}

    # --- Final Z Homing ---
    _SET_STATUS_HOMING
    CG28
    G28 Z METHOD=proximity CALIBRATE=0


[gcode_macro PHASE_2]
description: Runs QGL and creates the bed mesh.
gcode:
    # --- 1. Wipe Nozzle for Calibration ---
    # Nozzle was heated in PHASE_1, so we clean it now for accurate Z probing.
    M117 Wiping nozzle for calibration...
    PARK_WIPE

    # --- 2. Initial Z Calibration ---
    M117 Calibrating...
    _SET_STATUS_CALIBRATING_Z
    G28 Z METHOD=CONTACT CALIBRATE=1  ; Calibrate Z offset and Beacon model (will be hot)

    # --- 3. QGL ---
    _SET_STATUS_LEVELING
    QUAD_GANTRY_LEVEL

    # --- 4. Bed Mesh ---
    _SET_STATUS_MESHING
    MESH_CALIBRATE RUNS=2

    # --- 5. Final Z Check ---
    _SET_STATUS_CALIBRATING_Z
    G28 Z METHOD=CONTACT CALIBRATE=1  ; Re-check Z


[gcode_macro PHASE_3]
description: Heats nozzle to final temp, wipes, and runs the purge line.
gcode:
    # Get Slicer Params
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}

    _SET_STATUS_HEATING
    M117 Final heating...
    M109 S{EXTRUDER_TEMP}
    
    # --- Wipe Nozzle Before Purge ---
    # Cleans off the "ooze" created during the final heat-up
    M117 Wiping final ooze...
    PARK_WIPE
    
    # --- Apply Offsets ---
    {% if sheet and sheet.name | lower == 'textured_pei' %}
        {action_respond_info("Textured sheet detected. Probed at temp, applying small squish offset.")}
        {% set OFFSET = 0.035  %}
    {% else %}
        {action_respond_info("Smooth PEI or other sheet detected. Expanding offset to account for thermal expansion.")}
        {% set OFFSET = 0.100  %}
    {% endif %}

    SET_GCODE_OFFSET Z=0
    RESET_BUILD_SHEET_OFFSET
    SET_GCODE_OFFSET Z={OFFSET} MOVE=1

    # --- Purge ---
    _SET_STATUS_PURGING
    M117 Purging...
    VORON_PURGE

    _SET_STATUS_PRINTING
    M117 Print starting!
    

[gcode_macro PRINT_END]
gcode:
    END_PRINT {rawparams}

[gcode_macro END_PRINT]
gcode:
    # Move nozzle away from print while retracting
    G91
    G1 Z5 E-2 F800     ; Raise Z by 5mm relative
    G1 E2 F800         ; Extrude slightly (tip shaping)
    G1 E-40 F800       ; Large retract (user defined)

    # Turn off bed, extruder, and fan
    M104 S0
    M106 S0
    
    # Park nozzle at Drip Stop and wipe
    # This automatically moves to absolute coords X45 Y350
    PARK_WIPE_PARK

    G90
    _SET_STATUS_OFF


[gcode_macro PAUSE]
description: Pause a print, parking the toolhead and saving filament temp.
rename_existing: PAUSE_BASE
gcode:
    _SET_STATUS_PAUSE
    
    # Only run park/save logic on the *first* pause command
    {% if printer['pause_resume'].is_paused|int == 0 %}
        
        # --- Get filament temperature from filament.cfg system ---
        _FILAMENTS_ASSERT_FILAMENT_SET
        {% set svv = printer.save_variables.variables %}
        {% set filament = svv.get(svv.get("filament_installed_t0")) %}

        # Parameters
        {% set z = params.Z|default(10)|int %} ; z hop amount

        # Save Z-hop and filament temp for RESUME
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={filament.extruder} 

        SAVE_GCODE_STATE NAME=PAUSE
        PAUSE_BASE ; <-- Sets the printer to the paused state
        
        # Park logic
        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}
            G91
            G1 Z{z} F900
        {% else %}
            { action_respond_info("Pause zhop exceeds maximum Z height.") }
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}
        
        G90
        # UPDATED: Use PARK to go to Drip Stop (X45 Y350) instead of FRONT
        PARK
        
        SAVE_GCODE_STATE NAME=PAUSEPARK
        M104 S0 ; Turn off extruder
        SET_IDLE_TIMEOUT TIMEOUT=43200 ; Set idle timeout to 12 hours
    {% endif %}


[gcode_macro RESUME]
description: Resume a print, handling both M600 and standard pauses.
rename_existing: RESUME_BASE
variable_zhop: 0
variable_etemp: 0
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set m600_state = svv.m600_state|default('') %}
    
    # --- Check for M600 Filament Change State ---
    {% if m600_state == 'loading' %}
        SAVE_VARIABLE VARIABLE=m600_state VALUE="'purging'"
        _INTERNAL_LOAD_FILAMENT 
        M117 Purge complete. Click RESUME again to continue.
    
    {% elif m600_state == 'purging' %}
        SAVE_VARIABLE VARIABLE=m600_state VALUE="''"
        # This restores the exact position where CHANGE_FILAMENT was called
        RESTORE_GCODE_STATE NAME=M600_state MOVE=1 MOVE_SPEED=100
        M117 Print Resuming...
        RESUME_BASE
    
    # --- Fallback to Standard Pause/Resume Logic ---
    {% elif printer['pause_resume'].is_paused|int == 1 %}
        # Parameters
        {% set e = params.E|default(2.5)|int %}
    
        _SET_STATUS_PRINTING
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
        {% if etemp > 0 %}
            M109 S{etemp|int}
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100
        G91
        M83
        {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
            G1 Z{zhop * -1} E{e} F900
        {% else %}
            G1 Z{zhop * -1} F900
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60
        RESUME_BASE
    
    {% else %}
        # This handles the case where RESUME is clicked but nothing is paused
        RESUME_BASE
    {% endif %}


[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
gcode:
    INTERRUPT_HEATER
    _SET_STATUS_CANCEL

    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
    CLEAR_PAUSE
    
    # Run the PRINT_END macro, which handles parking and turning off heaters/fans.
    # This will now utilize PARK_WIPE_PARK
    PRINT_END
    
    # Call the original Klipper command to cancel the print job.
    CANCEL_PRINT_BASE {rawparams}


[gcode_macro INTERRUPT_HEATER]
gcode:
    HEATER_INTERRUPT

## -------------------------------------------------------
## MOVEMENT MACROS
## -------------------------------------------------------

[gcode_macro FRONT]
description: Move toolhead to the front-center of the bed.
gcode:
    {% set x_center = printer.toolhead.axis_maximum.x / 2 %}
    {% set y_front = printer.toolhead.axis_minimum.y + 10 %}
    G90
    G0 X{x_center} Y{y_front} F{6000}

[gcode_macro CENTER]
description: Move toolhead to the absolute center of the bed.
gcode:
    {% set x_center = printer.toolhead.axis_maximum.x / 2 %}
    {% set y_center = printer.toolhead.axis_maximum.y / 2 %}
    G90
    G0 X{x_center} Y{y_center} F{6000}

[gcode_macro REAR]
description: Move toolhead to the rear-center of the bed.
gcode:
    {% set x_center = printer.toolhead.axis_maximum.x / 2 %}
    {% set y_rear = printer.toolhead.axis_maximum.y - 10 %}
    G90
    G0 X{x_center} Y{y_rear} F{6000}


## -------------------------------------------------------
## MOVEMENT MACROS
## -------------------------------------------------------

[gcode_macro PARK]
description: Park the toolhead at the Drip Stop location (X45 Y350) or specified location. [X], [Y], [Z]
gcode:
    # --- Get live printer dimensions and speeds ---
    {% set z_max = printer.toolhead.axis_maximum.z %}
    {% set z_pos = printer.toolhead.position.z %}
    {% set travel_speed = printer.toolhead.max_velocity * 60 * 0.5 %}
    {% set z_travel_speed = printer.configfile.settings.printer.max_z_velocity * 60 * 0.75 %} 
    
    # --- Define default park height ---
    {% set park_height = (z_max * 0.65)|int %}

    # --- Set park coordinates from parameters or defaults ---
    # Defaults to the "Drip Stop" location
    {% set x_park = params.X|default(45) %} 
    {% set y_park = params.Y|default(350) %}
    {% set z_park = (params.Z|default(park_height))|float %}
    
    # --- Save current G-Code state ---
    SAVE_GCODE_STATE NAME=PARK_STATE
    
    # --- Move Z axis to a safe height ---
    G90 ; Use absolute coordinates
    {% if z_pos < z_park %}
        G1 Z{z_park} F{z_travel_speed} ; Move up to park height
    {% endif %}
    
    # --- Move X and Y axes to park position ---
    G1 X{x_park} Y{y_park} F{travel_speed}
    
    # --- Restore G-Code state ---
    RESTORE_GCODE_STATE NAME=PARK_STATE


[gcode_macro PARK_WIPE]
description: Move to the nozzle wiper and clean the nozzle using an 8-pattern.
gcode:
    # Wipe Area Boundaries: X[55-85], Y[346-348]
    
    G90
    G0 X55 Y348 F12000       ; Move to Start Position (Top Left)

    # --- Wipe Sequence (Figure 8) ---
    G0 X85 Y346 F12000       ; 1. Down Right
    G0 X85 Y348 F12000       ; 2. Up
    G0 X55 Y346 F12000       ; 3. Down Left
    G0 X55 Y348 F12000       ; 4. Up
    G0 X85 Y348 F12000       ; 5. Right
    G0 X55 Y346 F12000       ; 6. Down Left (Cross)
    G0 X55 Y348 F12000       ; 7. Up
    G0 X85 Y346 F12000       ; 8. Down Right (Cross)
    G0 X85 Y347 F12000       ; 9. Up 
    G0 X55 Y347 F12000       ; 10. Left
    G0 X85 Y347 F12000       ; 11. Right


[gcode_macro PARK_WIPE_PARK]
description: Wipes the nozzle, performs a cleaning swipe past the bucket, and parks.
gcode:
    PARK_WIPE                ; Run the 8-pattern wiping sequence (ends at X85)
    
    # --- Exit Sweep ---
    # Safely move around the drip stop to enter from the far left (X20) to wipe off debris
    G0     Y300 F12000
    G0 X20 Y350 F12000       
    
    # Return to final Drip Stop Park location
    G0 X45 Y350 F12000       


[gcode_macro DRIP_STOP_PARK]
description: Alias to move directly to the drip stop location
gcode:
    G90
    G1 X45 Y350 F12000


[gcode_macro PARK_FOR_SERVICE]
description: Move toolhead to the front-center of the bed at Z=200 or specified location for service. [X], [Y], [Z]
gcode:
    {% set x_center = params.X|default(printer.toolhead.axis_maximum.x / 2) %}
    {% set y_front = params.Y|default(printer.toolhead.axis_minimum.y + 5) %}
    {% set z_height = params.Z|default(printer.toolhead.axis_maximum.z - 130) %}
    PARK X={x_center} Y={y_front} Z={z_height}
  
    
# [gcode_macro PRESENT]
# description: Presents the print on a CoreXY by moving the toolhead to the front-center.
# gcode:
#     # --- Get printer axis limits ---
#     {% set x_max = printer.toolhead.axis_maximum.x %}
#     {% set y_min = printer.toolhead.axis_minimum.y %}
#     {% set z_max = printer.toolhead.axis_maximum.z %}
    
#     # --- Calculate center of X-axis ---
#     {% set x_center = x_max / 2 %}
    
#     # --- Call the PARK macro to move the toolhead ---
#     # Moves to the front of the Y-axis and the center of the X-axis.
#     PARK X={x_center} Y={y_min + 5} Z={z_max - 30}


## -------------------------------------------------------
## CONDITIONAL MACROS
## -------------------------------------------------------

[gcode_macro CONDITIONAL_HOME]
gcode:
    CG28

[gcode_macro CHOME]
gcode: 
    CG28

[gcode_macro CG28]
description: Homes the printer if it has not been homed yet.
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}


## -------------------------------------------------------
## UPDATE MACROS
## -------------------------------------------------------

[gcode_macro _SET_MPC_MATERIAL]
description: Set heater MPC parameters for a given material, interpolating heat capacity based on target temperature. [MATERIAL]
variable_filament_table:
    ## This table stores material properties.
    ## 'density' is the filament density in g/cm^3.
    ## 'heat_capacity_map' is a list of (temperature, heat_capacity) points.
    ## The macro will interpolate between these points to find the correct value.
    ## For materials with a single value, just provide one point like (0, value).
    {
        # PLA: Note the significant spike around its glass transition temperature (Tg ~65¬∞C).
        "PLA": { "density": 1.25, "heat_capacity_map": [ (25, 1.80),
                                                        (60, 1.95),
                                                        (70, 2.50),  # Peak at Tg
                                                        (150, 2.20),
                                                        (210, 2.30) ] },
                                                        
        # PETG: Shows a steady increase in heat capacity with temperature.
        "PETG": { "density": 1.27, "heat_capacity_map": [ (60, 1.30),
                                                         (100, 1.76),
                                                         (150, 1.88),
                                                         (200, 1.97),
                                                         (250, 2.05) ] },
                                                         
        # ABS: Gradual increase in heat capacity.
        "ABS": { "density": 1.08, "heat_capacity_map": [ (25, 1.60),
                                                        (100, 1.85), # Near Tg
                                                        (200, 2.05),
                                                        (250, 2.15) ] },
                                                        

        # ASA: Very similar properties to ABS.
        "ASA": { "density": 1.09, "heat_capacity_map": [ (25, 1.50),
                                                        (100, 1.75), # Near Tg
                                                        (200, 1.95),
                                                        (250, 2.10) ] },
    }
    
gcode:
    {% set ns = namespace(heat_capacity=0) %}
    {% set material = params.MATERIAL | upper %}
    {% set heater = params.HEATER | default('extruder') %}
    
    {% if material in filament_table %}
        {% set target_temp = printer[heater].target | float %}
        {% set mat_data = filament_table[material] %}
        {% set density = mat_data.density %}
        {% set hc_map = mat_data.heat_capacity_map %}

        # --- Determine heat capacity based on target temperature ---
        
        # Handle single-point maps or temps outside the defined range by clamping to the nearest end-point
        {% if (hc_map | length) == 1 %}
            {% set ns.heat_capacity = hc_map[0][1] %}
        {% elif target_temp <= hc_map[0][0] %}
            {% set ns.heat_capacity = hc_map[0][1] %}
        {% elif target_temp >= hc_map[-1][0] %}
            {% set ns.heat_capacity = hc_map[-1][1] %}
        {% else %}
            # Perform linear interpolation for temps between points
            {% for i in range(hc_map | length - 1) %}
                {% set p1_temp, p1_hc = hc_map[i] %}
                {% set p2_temp, p2_hc = hc_map[i+1] %}

                {% if target_temp >= p1_temp and target_temp < p2_temp %}
                    # Interpolation formula: y = y1 + (x - x1) * (y2 - y1) / (x2 - x1)
                    {% set ns.heat_capacity = p1_hc + (target_temp - p1_temp) * (p2_hc - p1_hc) / (p2_temp - p1_temp) %}
                    {% break %}
                {% endif %}
            {% endfor %}
        {% endif %}

        RESPOND PREFIX=üî• MSG="Configured {heater} MPC for {material} at {target_temp}¬∞C. Density: {density}, Calculated Heat Capacity: {ns.heat_capacity | round(3)}"
        MPC_SET HEATER={heater} FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={ns.heat_capacity}

    {% else %}
        # Fallback for unknown materials
        {% set extruder_config = printer.configfile.settings[heater] %}
        {% set density = extruder_config.filament_density %}
        {% set heat_capacity = extruder_config.filament_heat_capacity %}

        RESPOND PREFIX=‚ö†Ô∏èüî• MSG="Unknown material '{material}', using default MPC parameters for {heater}"
        MPC_SET HEATER={heater} FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={heat_capacity}
    {% endif %}


[gcode_macro _FILAMENT_VARS]
variable_filament_table:
# The format for each entry is:
# "MATERIAL_NAME": (retract_length, retract_speed, unretract_extra_length, unretract_speed)
  {
    # --- Base Filaments ---
    "PLA":      (0.5, 30, 0, 20),
    "PETG":     (0.5, 45, 0, 30),
    "ASA":      (0.3, 30, 0, 20),
    "ABS":      (0.2, 30, 0, 20),
    "TPU":      (0.8, 20, 0, 10),
    "NYLON":    (0.8, 30, 0, 20),
    "PC":       (0.5, 45, 0, 30),
  }
gcode: # Variable storage only

[gcode_macro _MATERIAL_VARS]
variable_pa_constants:
# The format for each entry is:
# "MATERIAL_NAME": (K-factor [constant])
  {
    "PLA":      (85),
    "PETG":     (100),
    "COPE":     (85),
    "ABS":      (95),
    "TPU":      (140),
    "NYLON":    (120),
    "ASA":      (100),
    "PVB":      (85),
    "PA":       (120),
    "FLEX":     (140),
  }
gcode: # This macro is for variable storage only


[gcode_macro _SET_FIRMWARE_RETRACTION]
description: Set printer retract parameters for given materials. [MATERIAL]
gcode:
  {% set filament_table = printer['gcode_macro _FILAMENT_VARS'].filament_table %}
  {% set input_material = params.MATERIAL | default('PLA') | upper %}

  # --- Find a valid lookup key ---
  # First, check for an exact match
  {% set lookup_key = input_material %}
  # If no exact match, and the material name contains an underscore, use the base
  {% if lookup_key not in filament_table and '_' in input_material %}
    {% set lookup_key = input_material.split('_')[0] %}
  {% endif %}
  
  # --- Apply the found settings ---
  {% if lookup_key in filament_table %}
    # Retrieve the settings from the table.
    {% set R_LENGTH, R_SPEED, U_EXTRA, U_SPEED = filament_table[lookup_key] %}

    # Send a message to the console confirming the change.
    RESPOND PREFIX=‚¨ÜÔ∏è TYPE=command MSG="Setting firmware retraction for {input_material}. Using settings for '{lookup_key}'. Retract Length: {R_LENGTH} Retract Speed: {R_SPEED} Load Length: {U_EXTRA} Load Speed: {U_SPEED}"

    # Apply the new retraction settings.
    SET_RETRACTION RETRACT_LENGTH={R_LENGTH} RETRACT_SPEED={R_SPEED} UNRETRACT_EXTRA_LENGTH={U_EXTRA} UNRETRACT_SPEED={U_SPEED}

  {% else %}
    # If the material is not found, raise an error.
    { action_raise_error("Unknown material: '" ~ input_material ~ "'. Please add it to the _SET_FIRMWARE_RETRACTION macro table.") }
  {% endif %}


[gcode_macro _CALCULATE_PA]
description: Calculates and sets Linear Pressure Advance for set filaments and speeds. [MATERIAL], [NOZZLE_SIZE], [LAYER_HEIGHT], [PRINT_SPEED]
gcode:
    {% set filament_table = printer['gcode_macro _FILAMENT_VARS'].filament_table %}
    {% set pa_constants = printer['gcode_macro _MATERIAL_VARS'].pa_constants %}
    {% set input_material = params.MATERIAL | default("PLA") | upper %}
    {% set nozzle_size = params.NOZZLE_SIZE | default(0.4) | float %}
    {% set layer_height = params.LAYER_HEIGHT | default(0.2) | float %}
    {% set print_speed = params.PRINT_SPEED | default(60) | float %}
    {% set filament_diameter = params.FILAMENT_DIAMETER | default(1.75) | float %}
    
    # --- Find a valid lookup key (for both tables) ---
    {% set lookup_key = input_material %}
    {% if lookup_key not in pa_constants and '_' in input_material %}
      {% set lookup_key = input_material.split('_')[0] %}
    {% endif %}

    # --- Calculation using the constant from the lookup table ---
    {% if lookup_key in pa_constants and lookup_key in filament_table %}
        {% set R_LENGTH, R_SPEED, U_EXTRA, U_SPEED = filament_table[lookup_key] %}
        {% set pa_constant = pa_constants[lookup_key] %}
        
        {% set filament_area = (3.14159 * (filament_diameter / 2) ** 2) %}
        {% set flow_rate = params.LINE_WIDTH|default(nozzle_size * 1.25)|float * layer_height * print_speed %}
        
        ; --- The corrected calculation using the material-specific constant ---
        {% set pressure_advance = (((flow_rate * (R_LENGTH / R_SPEED)) / (pa_constant * filament_area)) * 100 ) %}
        
        SET_PRESSURE_ADVANCE ADVANCE={pressure_advance|round(12)}
        
        RESPOND TYPE=command MSG="‚¨áÔ∏è Calculated PA for {input_material} using '{lookup_key}' constant: {pressure_advance|round(4)}"
    {% else %}
        RESPOND TYPE=command MSG="‚ö†Ô∏è Unknown material '{input_material}' for PA calculation. Using printer default."
    {% endif %}


## -------------------------------------------------------
## Nozzle && Filaments
## -------------------------------------------------------

[gcode_macro NOZZLE_40]
description: Sets nozzle diameter to 0.40mm.
gcode:
    CHANGE_NOZZLE NOZZLE_DIAMETER=0.4

[gcode_macro NOZZLE_60]
description: Sets nozzle diameter to 0.60mm.
gcode:
    CHANGE_NOZZLE NOZZLE_DIAMETER=0.6

## Filaments stored in Filaments.cfg


## -------------------------------------------------------
## UPDATE GITHUB CONFIG
## -------------------------------------------------------

[delayed_gcode _klipper_shutdown_stage_2]
# This delayed G-code macro performs the host machine shutdown actions.
# It is triggered 30 seconds after _klipper_shutdown_stage_1 issues BACKUP_CFG.
initial_duration: 0 # This ensures it only runs when explicitly updated.
gcode:
    {action_call_remote_method("shutdown_machine")} ; Moonraker compatible host shutdown
    {action_respond_info('action:poweroff')}    ; OctoPrint compatible host shutdown

## -------------------------------------------------------

[delayed_gcode _klipper_shutdown_stage_1]
# This delayed G-code macro handles the configuration backup.
# It is triggered 1 second after the OFF macro completes.
initial_duration: 0 # This ensures it only runs when explicitly updated.
gcode:
    # Perform the configuration backup
    BACKUP_CFG
    # Schedule the final power-off stage.
    # This accounts for the 30-second delay from the original SHUTDOWN macro.
    # The duration is set to 30 seconds, meaning the power-off will occur 30 seconds
    # after the BACKUP_CFG command has been issued.
    UPDATE_DELAYED_GCODE ID=_klipper_shutdown_stage_2 DURATION=30

## -------------------------------------------------------

[gcode_shell_command backup_cfg]
command: ~/printer_data/config/autocommit.sh
timeout: 25
verbose: True

## -------------------------------------------------------

[gcode_macro BACKUP_CFG]
description: Backs up config directory GitHub
gcode:
    RUN_SHELL_COMMAND CMD=backup_cfg


#-----------------------------------------------------------------------------
    
[gcode_macro OFF]
gcode:
    M84                                         ; Turn steppers off
    TURN_OFF_HEATERS                            ; Turn bed / hotend off
    M107                                        ; Turn print cooling fan off
    SET_FAN_SPEED FAN=chamber_filter SPEED=0    ; turn chamber filter fan off
    _SET_STATUS_OFF
    SET_PIN PIN=caselight VALUE=0               ; turn case light off
    # Schedule the next stage of shutdown (backup) after a short delay (1 second)
    # This replaces the initial G4 P1000 from the original SHUTDOWN macro.
    UPDATE_DELAYED_GCODE ID=_klipper_shutdown_stage_1 DURATION=1




[gcode_macro _MANUAL_QGL_EXTENDED_CALIBRATION]
description: Runs a 5-phase probing sequence to gather data for X and Y gantry corner calculation.
gcode:
    {% set DELTA = 1.0 %}
    {% set Z_VEL = 5 %}
    # --- IMPORTANT ---
    # Get the probe points directly from your [quad_gantry_level] config.
    # No need to edit them here.
    {% set probe_points = printer.configfile.settings.quad_gantry_level.points %}

    RESPOND MSG="Starting Extended Quad Gantry Level calibration sequence..."
    
    # Ensure printer is ready
    G28
    QUAD_GANTRY_LEVEL
    G28 Z
    
    # --- Phase 0: Baseline Probe ---
    RESPOND MSG="--- PHASE 0: BASELINE PROBE ---"
    {% for point in probe_points %}
        # --- FIX: Unpack the tuple directly ---
        {% set x, y = point %}
        G0 X{x} Y{y} F9000
        PROBE
    {% endfor %}

    # --- Phase 1: Left Motors Lifted ---
    RESPOND MSG="--- PHASE 1: LEFT MOTORS LIFTED (+{DELTA}mm) ---"
    FORCE_MOVE STEPPER=stepper_z DISTANCE={DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z1 DISTANCE={DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500
    {% for point in probe_points %}
        {% set x, y = point %}
        G0 X{x} Y{y} F9000
        PROBE
    {% endfor %}
    FORCE_MOVE STEPPER=stepper_z DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z1 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500

    # --- Phase 2: Right Motors Lifted ---
    RESPOND MSG="--- PHASE 2: RIGHT MOTORS LIFTED (+{DELTA}mm) ---"
    FORCE_MOVE STEPPER=stepper_z2 DISTANCE={DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z3 DISTANCE={DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500
    {% for point in probe_points %}
        {% set x, y = point %}
        G0 X{x} Y{y} F9000
        PROBE
    {% endfor %}
    FORCE_MOVE STEPPER=stepper_z2 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z3 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500

    # --- Phase 3: Front Motors Lifted ---
    RESPOND MSG="--- PHASE 3: FRONT MOTORS LIFTED (+{DELTA}mm) ---"
    FORCE_MOVE STEPPER=stepper_z DISTANCE={DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z3 DISTANCE={DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500
    {% for point in probe_points %}
        {% set x, y = point %}
        G0 X{x} Y{y} F9000
        PROBE
    {% endfor %}
    FORCE_MOVE STEPPER=stepper_z DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z3 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500

    # --- Phase 4: Back Motors Lifted ---
    RESPOND MSG="--- PHASE 4: BACK MOTORS LIFTED (+{DELTA}mm) ---"
    FORCE_MOVE STEPPER=stepper_z1 DISTANCE={DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z2 DISTANCE={DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500
    {% for point in probe_points %}
        {% set x, y = point %}
        G0 X{x} Y{y} F9000
        PROBE
    {% endfor %}
    FORCE_MOVE STEPPER=stepper_z1 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z2 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500

    RESPOND MSG="--- EXTENDED SEQUENCE COMPLETE ---"
    # Re-home Z to ensure Klipper knows the correct Z position
    G28 Z

