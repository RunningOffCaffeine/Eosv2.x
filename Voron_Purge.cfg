[gcode_macro VORON_PURGE]
description: A purge macro that adapts to be near your actual printed objects, with dynamic extrusion based on nozzle and filament diameters.
gcode:
    # Get relevant printer params
    {% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
    
    # Use firmware retraction if it is defined
    {% if printer.firmware_retraction is defined %}
        {% set RETRACT = 'G10' %}
        {% set UNRETRACT = 'G11' %}
    {% else %}
        {% set RETRACT = 'G1 E-.5 F2100' %}
        {% set UNRETRACT = 'G1 E.5 F2100' %}
    {% endif %}

    # Get KAMP settings and nozzle/filament parameters
    {% set kamp_settings = printer["gcode_macro _KAMP_Settings"] %}
    {% set verbose_enable = kamp_settings.verbose_enable | default(False) | as_bool %}
    {% set purge_height = kamp_settings.purge_height | float %}
    {% set tip_distance = kamp_settings.tip_distance | float %}
    {% set purge_margin = kamp_settings.purge_margin | float %}
    {% set flow_rate = kamp_settings.flow_rate | float %}
    {% set size = 10 | float %}
    
    # --- New parameters for dynamic extrusion calculation ---
    # Get nozzle and filament diameters from your printer's configuration
    {% set nozzle_diameter = printer.toolhead.extruder.nozzle_diameter | float %}
    {% set filament_diameter = printer.configfile.settings.extruder.filament_diameter | float %}
    
    # You can add 'purge_line_width_multiplier' to your _KAMP_Settings. Default is 1.5x nozzle diameter for a healthy purge line.
    {% set line_width_multiplier = kamp_settings.purge_line_width_multiplier | default(1.5) | float %}
    {% set line_width = nozzle_diameter * line_width_multiplier %}

    # Calculate extrusion amount per mm of travel, based on physical properties
    {% set filament_area = (filament_diameter / 2) ** 2 * 3.14159 %}
    {% set extrusion_factor = (line_width * purge_height) / filament_area %}

    # Calculate speeds based on the desired volumetric flow rate (from KAMP settings)
    # Speed for priming (extrusion only move)
    {% set prime_speed = (flow_rate / filament_area) * 60 %}
    # Speed for purge lines (XY travel with extrusion)
    {% set purge_move_speed = (flow_rate * 60) / (line_width * purge_height) %}

    # Calculate purge origins from objects, with a fallback if no objects are present
    {% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
    {% if all_points %}
        {% set purge_x_min = (all_points | map(attribute=0) | min) %}
        {% set purge_y_min = (all_points | map(attribute=1) | min) %}
    {% else %}
        # Fallback if no objects are present, purge near the front-left of the bed
        {% set purge_x_min = printer.toolhead.axis_minimum.x | float + purge_margin %}
        {% set purge_y_min = printer.toolhead.axis_minimum.y | float + purge_margin %}
    {% endif %}
    
    {% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
    {% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}

    # Calculate the length of each segment of the purge logo
    {% set line1_length = size * 0.5775 %}
    {% set line2_length = size * 1.155 %}
    {% set line3_length = size * 0.5775 %}

    # Check for max_extrude_cross_section, now based on the calculated line width and height
    {% set required_cross_section = line_width * purge_height %}
    {% if printer.configfile.settings.extruder.max_extrude_cross_section < required_cross_section %}
        {action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge. Set to at least %.2f. Purge skipped." % required_cross_section)}
    {% else %}
        {% if verbose_enable %}
            {action_respond_info("KAMP purging with dynamic extrusion: Nozzle=%.2f, Filament=%.2f, Line Width=%.2f, Layer Height=%.2f" % (nozzle_diameter, filament_diameter, line_width, purge_height))}
            {action_respond_info("Moving filament tip %.2fmm" % tip_distance)}
        {% endif %}

        SAVE_GCODE_STATE NAME=VORON_PURGE_State
        
        G92 E0
        G0 F{travel_speed}
        G90
        G0 X{purge_x_origin} Y{purge_y_origin + size / 2}
        G0 Z{purge_height}
        M83
        
        # Prime the nozzle by extruding the tip_distance amount
        G1 E{tip_distance} F{prime_speed}
        
        # Purge the three lines of the logo with calculated extrusion
        G1 X{purge_x_origin + size * 0.289} Y{purge_y_origin + size} E{extrusion_factor * line1_length} F{purge_move_speed}
        {RETRACT}
        G0 Z{purge_height * 2}
        G0 X{purge_x_origin + size * 0.789} Y{purge_y_origin + size}
        G0 Z{purge_height}
        {UNRETRACT}
        G1 X{purge_x_origin + size * 0.211} Y{purge_y_origin} E{extrusion_factor * line2_length} F{purge_move_speed}
        {RETRACT}
        G0 Z{purge_height * 2}
        G0 X{purge_x_origin + size * 0.711} Y{purge_y_origin}
        G0 Z{purge_height}
        {UNRETRACT}
        G1 X{purge_x_origin + size} Y{purge_y_origin + size / 2} E{extrusion_factor * line3_length} F{purge_move_speed}
        {RETRACT}
        
        G92 E0
        M82
        G0 Z{purge_height * 2} F{travel_speed}

        RESTORE_GCODE_STATE NAME=VORON_PURGE_State
    {% endif %}