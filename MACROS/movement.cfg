## -------------------------------------------------------
## MOVEMENT MACROS
## -------------------------------------------------------

[gcode_macro FRONT]
description: Move toolhead to the front-center of the bed.
gcode:
    {% set x_center = printer.toolhead.axis_maximum.x / 2 %}
    {% set y_front = printer.toolhead.axis_minimum.y + 10 %}
    G90
    G0 X{x_center} Y{y_front} F{6000}

[gcode_macro CENTER]
description: Move toolhead to the absolute center of the bed.
gcode:
    {% set x_center = printer.toolhead.axis_maximum.x / 2 %}
    {% set y_center = printer.toolhead.axis_maximum.y / 2 %}
    G90
    G0 X{x_center} Y{y_center} F{6000}

[gcode_macro REAR]
description: Move toolhead to the rear-center of the bed.
gcode:
    {% set x_center = printer.toolhead.axis_maximum.x / 2 %}
    {% set y_rear = printer.toolhead.axis_maximum.y - 10 %}
    G90
    G0 X{x_center} Y{y_rear} F{6000}


[gcode_macro PARK]
description: Park the toolhead at the Drip Stop location (X45 Y350) or specified location. [X], [Y], [Z]
gcode:
    # --- Get live printer dimensions and speeds ---
    {% set z_max = printer.toolhead.axis_maximum.z %}
    {% set z_pos = printer.toolhead.position.z %}
    {% set travel_speed = printer.toolhead.max_velocity * 60 * 0.5 %}
    {% set z_travel_speed = printer.configfile.settings.printer.max_z_velocity * 60 * 0.75 %} 
    
    # --- Define default park height ---
    {% set park_height = (z_max * 0.65)|int %}

    # --- Set park coordinates from parameters or defaults ---
    # Defaults to the "Drip Stop" location
    {% set x_park = params.X|default(45) %} 
    {% set y_park = params.Y|default(350) %}
    {% set z_park = (params.Z|default(park_height))|float %}
    
    # --- Save current G-Code state ---
    SAVE_GCODE_STATE NAME=PARK_STATE
    
    # --- Move Z axis to a safe height ---
    G90 ; Use absolute coordinates
    {% if z_pos < z_park %}
        G1 Z{z_park} F{z_travel_speed} ; Move up to park height
    {% endif %}
    
    # --- Move X and Y axes to park position ---
    G1 X{x_park} Y{y_park} F{travel_speed}
    
    # --- Restore G-Code state ---
    RESTORE_GCODE_STATE NAME=PARK_STATE


[gcode_macro PARK_WIPE]
description: Move to the nozzle wiper and clean the nozzle using an 8-pattern.
gcode:
    # Wipe Area Boundaries: X[55-85], Y[346-348]
    
    G90
    G0 X55 Y348 F12000       ; Move to Start Position (Top Left)

    # --- Wipe Sequence (Figure 8) ---
    G0 X85 Y346 F12000       ; 1. Down Right
    G0 X85 Y348 F12000       ; 2. Up
    G0 X55 Y346 F12000       ; 3. Down Left
    G0 X55 Y348 F12000       ; 4. Up
    G0 X85 Y348 F12000       ; 5. Right
    G0 X55 Y346 F12000       ; 6. Down Left (Cross)
    G0 X55 Y348 F12000       ; 7. Up
    G0 X85 Y346 F12000       ; 8. Down Right (Cross)
    G0 X85 Y347 F12000       ; 9. Up 
    G0 X55 Y347 F12000       ; 10. Left
    G0 X85 Y347 F12000       ; 11. Right


[gcode_macro PARK_WIPE_PARK]
description: Wipes the nozzle, performs a cleaning swipe past the bucket, and parks.
gcode:
    PARK_WIPE                ; Run the 8-pattern wiping sequence (ends at X85)
    
    # --- Exit Sweep ---
    # Safely move around the drip stop to enter from the far left (X20) to wipe off debris
    G0     Y300 F12000
    G0 X20 Y350 F12000       
    
    # Return to final Drip Stop Park location
    G0 X45 Y350 F12000       


[gcode_macro DRIP_STOP_PARK]
description: Alias to move directly to the drip stop location
gcode:
    G90
    G1 X45 Y350 F12000


[gcode_macro PARK_FOR_SERVICE]
description: Move toolhead to the front-center of the bed at Z=200 or specified location for service. [X], [Y], [Z]
gcode:
    {% set x_center = params.X|default(printer.toolhead.axis_maximum.x / 2) %}
    {% set y_front = params.Y|default(printer.toolhead.axis_minimum.y + 5) %}
    {% set z_height = params.Z|default(printer.toolhead.axis_maximum.z - 130) %}
    PARK X={x_center} Y={y_front} Z={z_height}


## -------------------------------------------------------
## CONDITIONAL MACROS
## -------------------------------------------------------

[gcode_macro CONDITIONAL_HOME]
gcode:
    CG28

[gcode_macro CHOME]
gcode: 
    CG28

[gcode_macro CG28]
description: Homes the printer if it has not been homed yet.
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

[gcode_macro _MANUAL_QGL_EXTENDED_CALIBRATION]
description: Runs a 5-phase probing sequence to gather data for X and Y gantry corner calculation.
gcode:
    {% set DELTA = 1.0 %}
    {% set Z_VEL = 5 %}
    # --- IMPORTANT ---
    # Get the probe points directly from your [quad_gantry_level] config.
    # No need to edit them here.
    {% set probe_points = printer.configfile.settings.quad_gantry_level.points %}

    RESPOND MSG="Starting Extended Quad Gantry Level calibration sequence..."
    
    # Ensure printer is ready
    G28
    QUAD_GANTRY_LEVEL
    G28 Z
    
    # --- Phase 0: Baseline Probe ---
    RESPOND MSG="--- PHASE 0: BASELINE PROBE ---"
    {% for point in probe_points %}
        # --- FIX: Unpack the tuple directly ---
        {% set x, y = point %}
        G0 X{x} Y{y} F9000
        PROBE
    {% endfor %}

    # --- Phase 1: Left Motors Lifted ---
    RESPOND MSG="--- PHASE 1: LEFT MOTORS LIFTED (+{DELTA}mm) ---"
    FORCE_MOVE STEPPER=stepper_z DISTANCE={DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z1 DISTANCE={DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500
    {% for point in probe_points %}
        {% set x, y = point %}
        G0 X{x} Y{y} F9000
        PROBE
    {% endfor %}
    FORCE_MOVE STEPPER=stepper_z DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z1 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500

    # --- Phase 2: Right Motors Lifted ---
    RESPOND MSG="--- PHASE 2: RIGHT MOTORS LIFTED (+{DELTA}mm) ---"
    FORCE_MOVE STEPPER=stepper_z2 DISTANCE={DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z3 DISTANCE={DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500
    {% for point in probe_points %}
        {% set x, y = point %}
        G0 X{x} Y{y} F9000
        PROBE
    {% endfor %}
    FORCE_MOVE STEPPER=stepper_z2 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z3 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500

    # --- Phase 3: Front Motors Lifted ---
    RESPOND MSG="--- PHASE 3: FRONT MOTORS LIFTED (+{DELTA}mm) ---"
    FORCE_MOVE STEPPER=stepper_z DISTANCE={DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z3 DISTANCE={DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500
    {% for point in probe_points %}
        {% set x, y = point %}
        G0 X{x} Y{y} F9000
        PROBE
    {% endfor %}
    FORCE_MOVE STEPPER=stepper_z DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z3 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500

    # --- Phase 4: Back Motors Lifted ---
    RESPOND MSG="--- PHASE 4: BACK MOTORS LIFTED (+{DELTA}mm) ---"
    FORCE_MOVE STEPPER=stepper_z1 DISTANCE={DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z2 DISTANCE={DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500
    {% for point in probe_points %}
        {% set x, y = point %}
        G0 X{x} Y{y} F9000
        PROBE
    {% endfor %}
    FORCE_MOVE STEPPER=stepper_z1 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    FORCE_MOVE STEPPER=stepper_z2 DISTANCE=-{DELTA} VELOCITY={Z_VEL}
    G0 Z{DELTA*2} F1500

    RESPOND MSG="--- EXTENDED SEQUENCE COMPLETE ---"
    # Re-home Z to ensure Klipper knows the correct Z position
    G28 Z