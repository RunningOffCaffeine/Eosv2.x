## -------------------------------------------------------
## PRINT START & END
## -------------------------------------------------------

[gcode_macro HEAT_SOAK]
description: Heats the bed (passively heating the chamber), then soaks. [TARGET], [CHAMBER], [DURATION]
variable_target_temp: 0
variable_chamber_target_temp: 0
variable_stage: None # heating_bed -> heating_chamber -> soaking -> done -> None

## in seconds
variable_check_interval: 10
variable_soak_time_remaining: 0
variable_total_time_elapsed: 0

gcode:
    {% set TARGET = params.TARGET | default(0) | float %}
    {% set CHAMBER_TARGET = params.CHAMBER | default(0) | float %}
    {% set DURATION = (params.DURATION | default(5) | int) * 60 %} ## minutes to seconds

    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=target_temp           VALUE={ TARGET }
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=chamber_target_temp   VALUE={ CHAMBER_TARGET }
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage                 VALUE="'heating_bed'"
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining   VALUE={ DURATION }
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed    VALUE=0

    CG28
  
    # Fire up the bed heater (this will also passively heat the chamber)
    _SET_STATUS_HEATING
    M140 S{ TARGET }

    # Run the fan to circulate air
    SET_FAN_SPEED FAN=chamber_filter SPEED=255

    # Park the toolhead
    CENTER
    # PARK_WIPE_PARK

    UPDATE_DELAYED_GCODE ID=heat_soaker DURATION={ check_interval }

[gcode_macro CANCEL_HEAT_SOAK]
description: Cancels an in-progress HEAT_SOAK cycle.
gcode:
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage VALUE="'cancel'"
    UPDATE_DELAYED_GCODE ID=heat_soaker DURATION=1

[delayed_gcode heat_soaker]
gcode:
    {% set heat_soak = printer['gcode_macro HEAT_SOAK'] %}

    ## update total time elapsed
    {% set total_time_elapsed = heat_soak.total_time_elapsed + heat_soak.check_interval %}
    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed VALUE={ total_time_elapsed }

    {% set stage = heat_soak.stage %}
    {% set target_bed = heat_soak.target_temp %}
    {% set target_chamber = heat_soak.chamber_target_temp %}

    # Get the chamber sensor object (must match your config)
    {% set chamber_sensor = printer["temperature_sensor Chamber"] %}

    # --- State Machine ---
    {% if stage == "heating_bed" %}
        # Wait for bed to reach temp
        {% if printer.heater_bed.temperature >= target_bed %}
            {% if target_chamber > 0 %}
                {% set stage = "heating_chamber" %} # Move to check chamber
            {% else %}
                {% set stage = "soaking" %}         # No chamber wait, start soaking
            {% endif %}
        {% endif %}

    {% elif stage == "heating_chamber" %}
        # Wait for *passive* chamber sensor to reach temp
        {% if chamber_sensor.temperature >= target_chamber %}
            {% set stage = "soaking" %} # Chamber is hot, start soaking
        {% endif %}

    {% elif stage == "soaking" %}
        # Countdown soak time
        {% set soak_time_remaining = [heat_soak.soak_time_remaining - heat_soak.check_interval, 0] | max %}
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining VALUE={ soak_time_remaining }

        {% if soak_time_remaining == 0 %}
            {% set stage = "done" %}
        {% endif %}
    {% endif %}

    SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=stage VALUE="'{ stage }'"
    # --- End State Machine ---


    {% if stage in ("done", "cancel") %}
        # --- Cleanup ---
        {% if stage == "cancel" %}
            {% set stage = "done" %}
            TURN_OFF_HEATERS # This will turn off the bed heater
            SET_FAN_SPEED FAN=chamber_filter SPEED=0
            
            {% set msg = "soak cancelled after ~%.1fm" | format(total_time_elapsed / 60.0) %}
            M117 {msg}
            RESPOND TYPE=command MSG="{msg}"
            
            _SET_STATUS_READY
        {% else %}
            {% set msg = "soak complete after %.1fm" | format(total_time_elapsed / 60.0) %}
            M117 {msg}
            RESPOND TYPE=command MSG="{msg}"
            
            _SET_STATUS_READY
        {% endif %}

        ## reset all state vars
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=target_temp           VALUE=0
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=chamber_target_temp   VALUE=0
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=soak_time_remaining   VALUE=0
        SET_GCODE_VARIABLE MACRO=HEAT_SOAK VARIABLE=total_time_elapsed    VALUE=0

    {% else %}
        # --- Reschedule ---
        
        # Define the message based on current stage
        {% set msg = "" %}
        {% if stage == "heating_bed" %}
            {% set msg = "heating bed (%.0fC) -- %.1fm elapsed" | format(printer.heater_bed.temperature, total_time_elapsed / 60.0) %}
        {% elif stage == "heating_chamber" %}
            {% set msg = "heating chamber (%.0fC) -- %.1fm elapsed" | format(chamber_sensor.temperature, total_time_elapsed / 60.0) %}
        {% elif stage == "soaking" %}
            {% set msg = "soaking -- %.1fm remaining" | format(soak_time_remaining / 60.0) %}
        {% endif %}

        # 1. Output to Display (M117) every 30 seconds
        {% if total_time_elapsed % 30 == 0 %}
            M117 {msg}
        {% endif %}

        # 2. Output to Console (RESPOND) every 150 seconds (2.5 mins)
        {% if total_time_elapsed % 150 == 0 %}
            RESPOND TYPE=command MSG="{msg}"
        {% endif %}

        ## trigger ourselves again
        UPDATE_DELAYED_GCODE ID=heat_soaker DURATION={ heat_soak.check_interval }

        ## dwell for 1ms to prevent from going idle
        G4 P1

    {% endif %}


[gcode_macro PHASE_1]
description: Sets profiles, heats bed/nozzle to targets, and homes Z. (Heat Soak assumed external/complete).
gcode:
    _SET_STATUS_READY

    # --- Get all slicer parameters ---
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    {% set MATERIAL = params.MATERIAL|default("PLA")|upper %}
    {% set NOZZLE_SIZE = params.NOZZLE_SIZE|default(0.4)|float %}
    {% set LAYER_HEIGHT = params.LAYER_HEIGHT|default(0.2)|float %}
    {% set PRINT_SPEED = params.PRINT_SPEED|default(60)|float %}
    {% set TUBE_LENGTH = params.TUBE_LENGTH|default(0.5)|float %}

    # --- NOZZLE SIZE VERIFICATION ---
    {% set KLIPPER_NOZZLE = printer.extruder.nozzle_diameter %}
    {% if (NOZZLE_SIZE - KLIPPER_NOZZLE)|abs > 0.01 %}
        {action_raise_error("Nozzle size mismatch! Slicer: %.2fmm, Printer: %.2fmm." % (NOZZLE_SIZE, KLIPPER_NOZZLE))}
    {% endif %}

    # --- Set initial printer state & filament profiles ---
    M117 Setting material profiles...
    SET_GCODE_OFFSET Z=0 MOVE=1

    # Quick M104 switch so MPC gets set properly
    M104 S{EXTRUDER_TEMP}
    _SET_MPC_MATERIAL MATERIAL={MATERIAL}
    M104 S0
    
    _SET_FIRMWARE_RETRACTION MATERIAL={MATERIAL}

    # --- Pressure Advance Calculation ---
    _CALCULATE_PA MATERIAL={MATERIAL} NOZZLE_SIZE={NOZZLE_SIZE} LAYER_HEIGHT={LAYER_HEIGHT} PRINT_SPEED={PRINT_SPEED} TUBE_LENGTH={TUBE_LENGTH}

    # --- Heating and Homing ---
    BED_MESH_CLEAR
    M117 Heating bed...

    _SET_STATUS_HEATING
    
    # 1. Start Bed Heating
    M140 S{BED_TEMP} 
    
    # 2. Preheat nozzle safely (150C) to prevent cold extrusion errors but allow fan usage
    M104 S150 

    # 3. Park at Drip Stop while waiting
    CG28              ; Conditional home (only if needed)
#    PARK_WIPE_PARK    ; Wipe and move to X45 Y350
    PARK Z=10
    
    # 4. Wait for Bed Temp
    M190 S{BED_TEMP}

    # --- Nozzle Heating for Probing ---
    M117 Heating nozzle to probe temp...
    {% if sheet and sheet.name | lower == 'textured_pei' %}
        {action_respond_info("Textured PEI detected. Heating nozzle to full temp (" ~ EXTRUDER_TEMP ~ "°C) for probing.")}
        M109 S{EXTRUDER_TEMP}
        G4 P10000
    {% else %}
        {action_respond_info("Standard sheet detected. Heating nozzle to 150°C for probing.")}
        M109 S150
        G4 P10000
    {% endif %}

    # --- Final Z Homing ---
    _SET_STATUS_HOMING
    CG28
    G28 Z METHOD=proximity CALIBRATE=0


[gcode_macro PHASE_2]
description: Runs QGL and creates the bed mesh.
gcode:
    # --- 1. Wipe Nozzle for Calibration ---
    # Nozzle was heated in PHASE_1, so we clean it now for accurate Z probing.
    M117 Wiping nozzle for calibration...
#    PARK_WIPE

    # --- 2. Initial Z Calibration ---
    M117 Calibrating...
    _SET_STATUS_CALIBRATING_Z
    G28 Z METHOD=CONTACT CALIBRATE=1  ; Calibrate Z offset and Beacon model (will be hot)

    # --- 3. QGL ---
    _SET_STATUS_LEVELING
    QUAD_GANTRY_LEVEL

    # --- 4. Bed Mesh ---
    _SET_STATUS_MESHING
    MESH_CALIBRATE RUNS=2

    # --- 5. Final Z Check ---
    _SET_STATUS_CALIBRATING_Z
    G28 Z METHOD=CONTACT CALIBRATE=1  ; Re-check Z


[gcode_macro PHASE_3]
description: Heats nozzle to final temp, wipes, and runs the purge line.
gcode:
    # Get Slicer Params
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}

    _SET_STATUS_HEATING
    M117 Final heating...
    M109 S{EXTRUDER_TEMP}
    G4 P10000
    
    # --- Wipe Nozzle Before Purge ---
    # Cleans off the "ooze" created during the final heat-up
    M117 Wiping final ooze...
#    PARK_WIPE
    
    # --- Apply Offsets ---
    {% if sheet and sheet.name | lower == 'textured_pei' %}
        {action_respond_info("Textured sheet detected. Probed at temp, applying small squish offset.")}
        {% set OFFSET = 0.035  %}
    {% else %}
        {action_respond_info("Smooth PEI or other sheet detected. Expanding offset to account for thermal expansion.")}
        {% set OFFSET = 0.100  %}
    {% endif %}

    SET_GCODE_OFFSET Z=0
    RESET_BUILD_SHEET_OFFSET
    SET_GCODE_OFFSET Z={OFFSET} MOVE=1

    # --- Purge ---
    _SET_STATUS_PURGING
    M117 Purging...
    VORON_PURGE

    _SET_STATUS_PRINTING
    M117 Print starting!

[gcode_macro PRINT_END]
gcode:
    END_PRINT {rawparams}

[gcode_macro END_PRINT]
gcode:
    # Move nozzle away from print while retracting
    G91
    G1 Z5 E-2 F800     ; Raise Z by 5mm relative
    G1 E2 F800         ; Extrude slightly (tip shaping)
    G1 E-40 F800       ; Large retract (user defined)

    # Turn off bed, extruder, and fan
    M104 S0
    M106 S0
    
    # Park nozzle at Drip Stop and wipe
    # This automatically moves to absolute coords X45 Y350
#    PARK_WIPE_PARK
    PARK

    G90
    _SET_STATUS_OFF


[gcode_macro PAUSE]
description: Pause a print, parking the toolhead and saving filament temp.
rename_existing: PAUSE_BASE
gcode:
    _SET_STATUS_PAUSE
    
    # Only run park/save logic on the *first* pause command
    {% if printer['pause_resume'].is_paused|int == 0 %}
        
        # --- Get filament temperature from filament.cfg system ---
        _FILAMENTS_ASSERT_FILAMENT_SET
        {% set svv = printer.save_variables.variables %}
        {% set filament = svv.get(svv.get("filament_installed_t0")) %}

        # Parameters
        {% set z = params.Z|default(10)|int %} ; z hop amount

        # Save Z-hop and filament temp for RESUME
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={filament.extruder} 

        SAVE_GCODE_STATE NAME=PAUSE
        PAUSE_BASE ; <-- Sets the printer to the paused state
        
        # Park logic
        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}
            G91
            G1 Z{z} F900
        {% else %}
            { action_respond_info("Pause zhop exceeds maximum Z height.") }
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}
        
        G90
        # UPDATED: Use PARK to go to Drip Stop (X45 Y350) instead of FRONT
        PARK
        
        SAVE_GCODE_STATE NAME=PAUSEPARK
        M104 S0 ; Turn off extruder
        SET_IDLE_TIMEOUT TIMEOUT=43200 ; Set idle timeout to 12 hours
    {% endif %}


[gcode_macro RESUME]
description: Resume a print, handling both M600 and standard pauses.
rename_existing: RESUME_BASE
variable_zhop: 0
variable_etemp: 0
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set m600_state = svv.m600_state|default('') %}
    
    # --- Check for M600 Filament Change State ---
    {% if m600_state == 'loading' %}
        SAVE_VARIABLE VARIABLE=m600_state VALUE="'purging'"
        _INTERNAL_LOAD_FILAMENT 
        M117 Purge complete. Click RESUME again to continue.
    
    {% elif m600_state == 'purging' %}
        SAVE_VARIABLE VARIABLE=m600_state VALUE="''"
        # This restores the exact position where CHANGE_FILAMENT was called
        RESTORE_GCODE_STATE NAME=M600_state MOVE=1 MOVE_SPEED=100
        M117 Print Resuming...
        RESUME_BASE
    
    # --- Fallback to Standard Pause/Resume Logic ---
    {% elif printer['pause_resume'].is_paused|int == 1 %}
        # Parameters
        {% set e = params.E|default(2.5)|int %}
    
        _SET_STATUS_PRINTING
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
        {% if etemp > 0 %}
            M109 S{etemp|int}
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100
        G91
        M83
    
        {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
            G1 Z{zhop * -1} E{e} F900
        {% else %}
            G1 Z{zhop * -1} F900
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60
        RESUME_BASE
    
    {% else %}
        # This handles the case where RESUME is clicked but nothing is paused
        RESUME_BASE
    {% endif %}


[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
gcode:
    INTERRUPT_HEATER
    _SET_STATUS_CANCEL

    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
    CLEAR_PAUSE
    
    # Run the PRINT_END macro, which handles parking and turning off heaters/fans.
    # This will now utilize PARK_WIPE_PARK
    PRINT_END
    
    # Call the original Klipper command to cancel the print job.
    CANCEL_PRINT_BASE {rawparams}


[gcode_macro INTERRUPT_HEATER]
gcode:
    HEATER_INTERRUPT