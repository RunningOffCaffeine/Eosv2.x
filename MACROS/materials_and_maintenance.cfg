## -------------------------------------------------------
## UPDATE MACROS
## -------------------------------------------------------

[gcode_macro _SET_MPC_MATERIAL]
description: Set heater MPC parameters for a given material, interpolating heat capacity based on target temperature. [MATERIAL]
variable_filament_table:
    ## This table stores material properties.
    ## 'density' is the filament density in g/cm^3.
    ## 'heat_capacity_map' is a list of (temperature, heat_capacity) points.
    ## The macro will interpolate between these points to find the correct value.
    ## For materials with a single value, just provide one point like (0, value).
    {
        # PLA: Note the significant spike around its glass transition temperature (Tg ~65Â°C).
        "PLA": { "density": 1.25, "heat_capacity_map": [ (25, 1.80),
                                                        (60, 1.95),
                                                        (70, 2.50),  # Peak at Tg
                                                        (150, 2.20),
                                                        (210, 2.30) ] },
                                                        
        # PETG: Shows a steady increase in heat capacity with temperature.
        "PETG": { "density": 1.27, "heat_capacity_map": [ (60, 1.30),
                                                         (100, 1.76),
                                                         (150, 1.88),
                                                         (200, 1.97),
                                                         (250, 2.05) ] },
                                                         
        # ABS: Gradual increase in heat capacity.
        "ABS": { "density": 1.08, "heat_capacity_map": [ (25, 1.60),
                                                        (100, 1.85), # Near Tg
                                                        (200, 2.05),
                                                        (250, 2.15) ] },
                                                        
        # ASA: Very similar properties to ABS.
        "ASA": { "density": 1.09, "heat_capacity_map": [ (25, 1.50),
                                                        (100, 1.75), # Near Tg
                                                        (200, 1.95),
                                                        (250, 2.10) ] },
    }
    
gcode:
    {% set ns = namespace(heat_capacity=0) %}
    {% set material = params.MATERIAL | upper %}
    {% set heater = params.HEATER | default('extruder') %}
    
    {% if material in filament_table %}
        {% set target_temp = printer[heater].target | float %}
        {% set mat_data = filament_table[material] %}
        {% set density = mat_data.density %}
        {% set hc_map = mat_data.heat_capacity_map %}

        # --- Determine heat capacity based on target temperature ---
        
        # Handle single-point maps or temps outside the defined range by clamping to the nearest end-point
        {% if (hc_map | length) == 1 %}
            {% set ns.heat_capacity = hc_map[0][1] %}
        {% elif target_temp <= hc_map[0][0] %}
            {% set ns.heat_capacity = hc_map[0][1] %}
        {% elif target_temp >= hc_map[-1][0] %}
            {% set ns.heat_capacity = hc_map[-1][1] %}
        {% else %}
            # Perform linear interpolation for temps between points
            {% for i in range(hc_map | length - 1) %}
                {% set p1_temp, p1_hc = hc_map[i] %}
                {% set p2_temp, p2_hc = hc_map[i+1] %}

                {% if target_temp >= p1_temp and target_temp < p2_temp %}
                    # Interpolation formula: y = y1 + (x - x1) * (y2 - y1) / (x2 - x1)
                    {% set ns.heat_capacity = p1_hc + (target_temp - p1_temp) * (p2_hc - p1_hc) / (p2_temp - p1_temp) %}
                    {% break %}
                {% endif %}
            {% endfor %}
        {% endif %}

        RESPOND PREFIX=ðŸ”¥ MSG="Configured {heater} MPC for {material} at {target_temp}Â°C. Density: {density}, Calculated Heat Capacity: {ns.heat_capacity | round(3)}"
        MPC_SET HEATER={heater} FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={ns.heat_capacity}

    {% else %}
        # Fallback for unknown materials
        {% set extruder_config = printer.configfile.settings[heater] %}
        {% set density = extruder_config.filament_density %}
        {% set heat_capacity = extruder_config.filament_heat_capacity %}

        RESPOND PREFIX=âš ï¸ðŸ”¥ MSG="Unknown material '{material}', using default MPC parameters for {heater}"
        MPC_SET HEATER={heater} FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={heat_capacity}
    {% endif %}


[gcode_macro _FILAMENT_VARS]
variable_filament_table:
# The format for each entry is:
# "MATERIAL_NAME": (retract_length, retract_speed, unretract_extra_length, unretract_speed)
  {
    # --- Base Filaments ---
    "PLA":      (0.5, 30, 0, 20),
    "PETG":     (0.5, 45, 0, 30),
    "ASA":      (0.3, 30, 0, 20),
    "ABS":      (0.2, 30, 0, 20),
    "TPU":      (0.8, 20, 0, 10),
    "NYLON":    (0.8, 30, 0, 20),
    "PC":       (0.5, 45, 0, 30),
  }
gcode: # Variable storage only

[gcode_macro _MATERIAL_VARS]
variable_pa_constants:
# The format for each entry is:
# "MATERIAL_NAME": (K-factor [constant])
  {
    "PLA":      (85),
    "PETG":     (100),
    "COPE":     (85),
    "ABS":      (95),
    "TPU":      (140),
    "NYLON":    (120),
    "ASA":      (100),
    "PVB":      (85),
    "PA":       (120),
    "FLEX":     (140),
  }
gcode: # This macro is for variable storage only


[gcode_macro _SET_FIRMWARE_RETRACTION]
description: Set printer retract parameters for given materials. [MATERIAL]
gcode:
  {% set filament_table = printer['gcode_macro _FILAMENT_VARS'].filament_table %}
  {% set input_material = params.MATERIAL | default('PLA') | upper %}

  # --- Find a valid lookup key ---
  # First, check for an exact match
  {% set lookup_key = input_material %}
  # If no exact match, and the material name contains an underscore, use the base
  {% if lookup_key not in filament_table and '_' in input_material %}
    {% set lookup_key = input_material.split('_')[0] %}
  {% endif %}
  
  # --- Apply the found settings ---
  {% if lookup_key in filament_table %}
    # Retrieve the settings from the table.
    {% set R_LENGTH, R_SPEED, U_EXTRA, U_SPEED = filament_table[lookup_key] %}

    # Send a message to the console confirming the change.
    RESPOND PREFIX=â¬†ï¸ TYPE=command MSG="Setting firmware retraction for {input_material}. Using settings for '{lookup_key}'. Retract Length: {R_LENGTH} Retract Speed: {R_SPEED} Load Length: {U_EXTRA} Load Speed: {U_SPEED}"

    # Apply the new retraction settings.
    SET_RETRACTION RETRACT_LENGTH={R_LENGTH} RETRACT_SPEED={R_SPEED} UNRETRACT_EXTRA_LENGTH={U_EXTRA} UNRETRACT_SPEED={U_SPEED}

  {% else %}
    # If the material is not found, raise an error.
    { action_raise_error("Unknown material: '" ~ input_material ~ "'. Please add it to the _SET_FIRMWARE_RETRACTION macro table.") }
  {% endif %}


[gcode_macro _CALCULATE_PA]
description: Calculates and sets Linear Pressure Advance for set filaments and speeds. [MATERIAL], [NOZZLE_SIZE], [LAYER_HEIGHT], [PRINT_SPEED]
gcode:
    {% set filament_table = printer['gcode_macro _FILAMENT_VARS'].filament_table %}
    {% set pa_constants = printer['gcode_macro _MATERIAL_VARS'].pa_constants %}
    {% set input_material = params.MATERIAL | default("PLA") | upper %}
    {% set nozzle_size = params.NOZZLE_SIZE | default(0.4) | float %}
    {% set layer_height = params.LAYER_HEIGHT | default(0.2) | float %}
    {% set print_speed = params.PRINT_SPEED | default(60) | float %}
    {% set filament_diameter = params.FILAMENT_DIAMETER | default(1.75) | float %}
    
    # --- Find a valid lookup key (for both tables) ---
    {% set lookup_key = input_material %}
    {% if lookup_key not in pa_constants and '_' in input_material %}
      {% set lookup_key = input_material.split('_')[0] %}
    {% endif %}

    # --- Calculation using the constant from the lookup table ---
    {% if lookup_key in pa_constants and lookup_key in filament_table %}
        {% set R_LENGTH, R_SPEED, U_EXTRA, U_SPEED = filament_table[lookup_key] %}
        {% set pa_constant = pa_constants[lookup_key] %}
        
        {% set filament_area = (3.14159 * (filament_diameter / 2) ** 2) %}
        {% set flow_rate = params.LINE_WIDTH|default(nozzle_size * 1.25)|float * layer_height * print_speed %}
        
        ; --- The corrected calculation using the material-specific constant ---
        {% set pressure_advance = (((flow_rate * (R_LENGTH / R_SPEED)) / (pa_constant * filament_area)) * 100 ) %}
        
        SET_PRESSURE_ADVANCE ADVANCE={pressure_advance|round(12)}
        
        RESPOND TYPE=command MSG="â¬‡ï¸ Calculated PA for {input_material} using '{lookup_key}' constant: {pressure_advance|round(4)}"
    {% else %}
        RESPOND TYPE=command MSG="âš ï¸ Unknown material '{input_material}' for PA calculation. Using printer default."
    {% endif %}


## -------------------------------------------------------
## Nozzle && Filaments
## -------------------------------------------------------

[gcode_macro NOZZLE_40]
description: Sets nozzle diameter to 0.40mm.
gcode:
    CHANGE_NOZZLE NOZZLE_DIAMETER=0.4

[gcode_macro NOZZLE_60]
description: Sets nozzle diameter to 0.60mm.
gcode:
    CHANGE_NOZZLE NOZZLE_DIAMETER=0.6

## Filaments stored in Filaments.cfg


## -------------------------------------------------------
## UPDATE GITHUB CONFIG
## -------------------------------------------------------

[delayed_gcode _klipper_shutdown_stage_2]
# This delayed G-code macro performs the host machine shutdown actions.
# It is triggered 30 seconds after _klipper_shutdown_stage_1 issues BACKUP_CFG.
initial_duration: 0 # This ensures it only runs when explicitly updated.
gcode:
    {action_call_remote_method("shutdown_machine")} ; Moonraker compatible host shutdown
    {action_respond_info('action:poweroff')}    ; OctoPrint compatible host shutdown

## -------------------------------------------------------

[delayed_gcode _klipper_shutdown_stage_1]
# This delayed G-code macro handles the configuration backup.
# It is triggered 1 second after the OFF macro completes.
initial_duration: 0 # This ensures it only runs when explicitly updated.
gcode:
    # Perform the configuration backup
    BACKUP_CFG
    # Schedule the final power-off stage.
    # This accounts for the 30-second delay from the original SHUTDOWN macro.
    # The duration is set to 30 seconds, meaning the power-off will occur 30 seconds
    # after the BACKUP_CFG command has been issued.
    UPDATE_DELAYED_GCODE ID=_klipper_shutdown_stage_2 DURATION=30

## -------------------------------------------------------

[gcode_shell_command backup_cfg]
command: ~/printer_data/config/backup.sh
timeout: 25
verbose: True

[gcode_shell_command restore_cfg]
command: ~/printer_data/config/restore.sh
timeout: 25
verbose: True

## -------------------------------------------------------

[gcode_macro BACKUP_CFG]
description: Backs up config directory GitHub
gcode:
    RUN_SHELL_COMMAND CMD=backup_cfg

[gcode_macro RESTORE_CFG]
description: Restores configs from GitHub
gcode:
    RUN_SHELL_COMMAND CMD=restore_cfg

#-----------------------------------------------------------------------------
    
[gcode_macro OFF]
gcode:
    M84                                         ; Turn steppers off
    TURN_OFF_HEATERS                            ; Turn bed / hotend off
    M107                                        ; Turn print cooling fan off
    SET_FAN_SPEED FAN=chamber_filter SPEED=0    ; turn chamber filter fan off
    _SET_STATUS_OFF
    SET_PIN PIN=caselight VALUE=0               ; turn case light off
    # Schedule the next stage of shutdown (backup) after a short delay (1 second)
    # This replaces the initial G4 P1000 from the original SHUTDOWN macro.
    UPDATE_DELAYED_GCODE ID=_klipper_shutdown_stage_1 DURATION=1